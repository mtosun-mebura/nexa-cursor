name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    env:
      DEPLOY_DIR: /var/www/nexa
      COMPOSE_FILE: docker-compose.prod.yml
      BACKEND_DIR: /var/www/nexa/backend

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Remove vendor/node_modules before rsync
        run: |
          set -e
          echo "üóëÔ∏è  Removing vendor/node_modules directories (worden in container gebouwd)..."
          # Verwijder vendor/node_modules volledig - worden opnieuw gebouwd in container
          sudo rm -rf "$DEPLOY_DIR"/backend/vendor 2>/dev/null || true
          sudo rm -rf "$DEPLOY_DIR"/backend/node_modules 2>/dev/null || true
          echo "‚úÖ Vendor/node_modules verwijderd"

      - name: Rsync code to server deploy dir
        run: |
          set -e
          echo "üìÇ Syncing repo -> $DEPLOY_DIR"
          mkdir -p "$DEPLOY_DIR"
          # Exclude vendor, node_modules en andere build artifacts
          # Deze worden in de container gebouwd tijdens docker build
          sudo rsync -a --delete \
            --no-perms --no-owner --no-group --omit-dir-times \
            --exclude '.env' \
            --exclude '.git' \
            --exclude 'backend/vendor' \
            --exclude 'backend/vendor/**' \
            --exclude 'backend/node_modules' \
            --exclude 'backend/node_modules/**' \
            --exclude 'backend/.env' \
            ./ "$DEPLOY_DIR"/
          echo "‚úÖ Synced to $DEPLOY_DIR"

      - name: Ensure Laravel dirs & .env exist
        run: |
          set -e
          cd "$BACKEND_DIR"
          mkdir -p bootstrap/cache \
                   storage/framework/{cache,sessions,views} \
                   storage/logs \
                   public/build
          echo "‚úÖ Laravel dirs klaar"
          
      - name: Ensure .env in root exists
        run: |
          set -e
          cd "$DEPLOY_DIR"
          # .env staat in root - wordt gebruikt door zowel Docker Compose als Laravel
          if [ ! -f .env ]; then
            echo "‚ö†Ô∏è  .env ontbreekt in root; kopieer backend/.env.example -> .env (pas waarden aan)"
            if [ -f "$BACKEND_DIR/.env.example" ]; then
              cp "$BACKEND_DIR/.env.example" .env
            else
              touch .env
            fi
          fi
          echo "‚úÖ .env in root aanwezig"

      - name: Build Vite assets (production)
        run: |
          set -e
          cd "$BACKEND_DIR"
          npm ci
          npm run build
          test -f public/build/manifest.json
          echo "‚úÖ Vite manifest aanwezig"
          
          # Fix permissions voor build directory
          sudo chown -R $USER:www-data public/build
          sudo chmod -R 755 public/build
          echo "‚úÖ Build directory permissions OK"

      - name: Pick docker compose (v2/v1)
        id: pickdc
        shell: bash
        run: |
          if docker compose version >/dev/null 2>&1; then
            echo "dc=docker compose" >> $GITHUB_OUTPUT
          else
            echo "dc=docker-compose" >> $GITHUB_OUTPUT
          fi

      - name: Ensure .env and APP_KEY
        run: |
          set -e
          cd "$DEPLOY_DIR"
          # .env staat nu in root (niet in backend)
          [ -f .env ] || cp "$BACKEND_DIR/.env.example" .env
          # Voeg een APP_KEY toe als hij ontbreekt
          if ! grep -q '^APP_KEY=' .env; then
            KEY=$(php -r "echo 'base64:'.base64_encode(random_bytes(32));")
            printf '\nAPP_KEY=%s\n' "$KEY" >> .env
            echo "APP_KEY added to .env"
          else
            echo "APP_KEY present"
          fi

      - name: Install PHP dependencies (in container tijdens build)
        run: |
          set -e
          cd "$DEPLOY_DIR"
          echo "üì¶ PHP dependencies worden ge√Ønstalleerd in container tijdens build..."
          # Composer install gebeurt in Dockerfile, maar we kunnen het hier ook doen voor zekerheid
          # Dit voorkomt dat we vendor moeten synchen
          
      - name: Build & start containers
        run: |
          set -e
          cd "$DEPLOY_DIR"
          dc="${{ steps.pickdc.outputs.dc }}"
          $dc -f "$COMPOSE_FILE" down --remove-orphans || true
          $dc -f "$COMPOSE_FILE" build --no-cache
          $dc -f "$COMPOSE_FILE" up -d
          echo "‚è≥ Wachten tot backend luistert..."
          tries=0
          until curl -fs http://127.0.0.1:8000 -I >/dev/null 2>&1; do
            tries=$((tries+1))
            if [ "$tries" -ge 20 ]; then
              echo "‚ùå Backend luistert niet op :8000 na $tries pogingen"
              echo "üìÑ Laatste 200 regels van container logs:"
              $dc -f "$COMPOSE_FILE" logs --tail=200 backend || true
              exit 1
            fi
            echo "‚è≥ Poging $tries/20 - wachten 3s..."
            sleep 3
          done
          echo "‚úÖ Backend OK op :8000"

      - name: Laravel post-deploy
        run: |
          cd /var/www/nexa
          docker compose -f docker-compose.prod.yml exec -T backend sh -c "chown www-data:www-data /var/www/html/.env && chmod 644 /var/www/html/.env" || true
          docker compose -f docker-compose.prod.yml exec -T backend php artisan config:clear
          docker compose -f docker-compose.prod.yml exec -T backend sh -c "if ! grep -q '^APP_KEY=' /var/www/html/.env || grep -q '^APP_KEY=$' /var/www/html/.env; then php artisan key:generate --force; else echo 'APP_KEY already set, skipping'; fi" || true
          docker compose -f docker-compose.prod.yml exec -T backend php artisan config:cache

      - name: Fix .env permissions before key:generate
        run: |
          set -e
          cd "$DEPLOY_DIR"
          dc="${{ steps.pickdc.outputs.dc }}"
          # Fix permissions for .env file in container
          $dc -f "$COMPOSE_FILE" exec -T backend sh -c "chown www-data:www-data /var/www/html/.env && chmod 644 /var/www/html/.env" || true
          echo "‚úÖ .env permissions fixed"

      - name: Laravel post-deploy (in container)
        run: |
          set -e
          cd "$DEPLOY_DIR"
          dc="${{ steps.pickdc.outputs.dc }}"
          # Generate key only if APP_KEY is not set (skip if already exists)
          $dc -f "$COMPOSE_FILE" exec -T backend sh -c "if ! grep -q '^APP_KEY=' /var/www/html/.env || grep -q '^APP_KEY=$' /var/www/html/.env; then php artisan key:generate --force; else echo 'APP_KEY already set, skipping'; fi" || true
          $dc -f "$COMPOSE_FILE" exec -T backend php artisan migrate --force
          $dc -f "$COMPOSE_FILE" exec -T backend php artisan config:clear
          $dc -f "$COMPOSE_FILE" exec -T backend php artisan cache:clear
          $dc -f "$COMPOSE_FILE" exec -T backend php artisan route:clear
          $dc -f "$COMPOSE_FILE" exec -T backend php artisan view:cache
          $dc -f "$COMPOSE_FILE" exec -T backend php artisan storage:link || true
          echo "‚úÖ Laravel caches & migraties voltooid"

      - name: Fix permissions for runtime dirs
        run: |
          set -e
          sudo chown -R $USER:www-data "$BACKEND_DIR"/storage "$BACKEND_DIR"/bootstrap/cache
          sudo chmod -R 775 "$BACKEND_DIR"/storage "$BACKEND_DIR"/bootstrap/cache
          echo "‚úÖ Permissies OK"

      - name: Reload Nginx
        run: |
          sudo systemctl reload nginx || true
          echo "‚úÖ Nginx reloaded"

      - name: Verify via Nginx
        run: |
          set -e
          curl -f https://nexa.tosun.nl -I || (echo "‚ùå Nginx pad faalt" && exit 1)
          echo "üéâ Deployment succesvol"
