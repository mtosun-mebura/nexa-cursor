import"./frontend-app-B6vhmd6y.js";console.log("üì¶ chat.js loaded!");let y=[],d=null,N=null,R=null,v=null,D=!1,w=!1,P=!1,B=!1,q=!1;window.openChatWithCandidate=function(e,t,s){if(console.log("üöÄ openChatWithCandidate called!",{candidateId:e,matchOrAppId:t,type:s}),!e){console.error("‚ùå No candidateId provided!");return}P=!1;const o=document.getElementById("chat_drawer"),l=document.getElementById("chat_drawer_backdrop");o&&o.removeAttribute("data-drawer-closed");const i=document.querySelector('[data-kt-drawer-toggle="#chat_drawer"]');if(i)i.click();else if(o){const n=window.KTDrawer?.getInstance?.(o);n?n.show():o.classList.remove("hidden")}const r=new FormData;r.append("candidate_id",e),t&&t!=="null"&&t!==null&&s&&s!=="null"&&s!==""&&(s==="match"?r.append("match_id",t):s==="application"&&r.append("application_id",t)),D=!0;const m=document.getElementById("chat_list_view"),a=document.getElementById("chat_messages_view");m&&(m.style.setProperty("display","none","important"),m.style.setProperty("visibility","hidden","important"),m.style.setProperty("opacity","0","important")),a&&(a.style.setProperty("display","flex","important"),a.style.setProperty("visibility","visible","important"),a.style.setProperty("opacity","1","important"),a.classList.remove("hidden")),setTimeout(()=>{fetch("/admin/chat/start",{method:"POST",headers:{"X-CSRF-TOKEN":M()},body:r}).then(n=>n.json()).then(n=>{if(n.success){if(console.log("‚úÖ Chat started successfully:",n.chat_id),D=!0,d=n.chat_id,n.chat){const u=y.findIndex(h=>h.id===n.chat.id);u===-1?y.unshift(n.chat):y[u]=n.chat,v=n.chat,console.log("‚úÖ Chat added to activeChats:",n.chat)}if(o){o.setAttribute("data-chat-active","true"),o.setAttribute("data-ignore-observer","true");const u=()=>{w=!0;try{o.style.setProperty("transform","translateX(0)","important"),o.style.setProperty("right","1.25rem","important"),o.style.setProperty("left","unset","important"),o.style.setProperty("display","flex","important"),o.style.setProperty("transition","none","important"),o.style.setProperty("animation","none","important"),o.style.left&&o.style.removeProperty("left");const h=o.getAttribute("style");if(h){const T=h.replace(/left\s*:\s*[^;!]+(!important)?;?/gi,"").trim();T!==h&&o.setAttribute("style",T)}o.style.setProperty("left","unset","important")}finally{setTimeout(()=>{w=!1},10)}};u(),requestAnimationFrame(()=>{u(),requestAnimationFrame(()=>{u()})}),setTimeout(u,10),setTimeout(u,50),setTimeout(u,100),setTimeout(u,200),setTimeout(u,300)}l&&l.classList.remove("hidden");const p=document.getElementById("chat_list_view"),f=document.getElementById("chat_messages_view");if(p&&(p.style.setProperty("display","none","important"),p.style.setProperty("visibility","hidden","important"),p.style.setProperty("opacity","0","important")),f&&(f.style.setProperty("display","flex","important"),f.style.setProperty("visibility","visible","important"),f.style.setProperty("opacity","1","important"),f.classList.remove("hidden")),console.log("‚úÖ Selecting chat:",n.chat_id),selectChat(n.chat_id),setTimeout(()=>{o&&(o.removeAttribute("data-ignore-observer"),console.log("‚úÖ Removed ignore-observer flag"))},2e3),n.chat){const u=y.findIndex(h=>h.id===n.chat.id);u===-1?y.unshift(n.chat):y[u]=n.chat,d===n.chat.id&&(v=n.chat)}setTimeout(()=>{loadActiveChats(!1).then(()=>{const u=document.getElementById("chat_list_view");u&&window.getComputedStyle(u).display!=="none"&&$(y)})},500),setTimeout(()=>{D=!1},3e3)}}).catch(n=>{console.error("Error starting chat:",n),D=!1})},100)};function M(){return document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||""}window.loadActiveChats=function(e=!1){return console.log("üìã loadActiveChats called, showListView:",e),fetch("/admin/chat/active",{headers:{"X-CSRF-TOKEN":M()},cache:"no-cache"}).then(t=>{if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return t.json()}).then(t=>{if(console.log("‚úÖ Active chats loaded from server:",t),console.log("üìä Server returned",t.length,"chats"),!Array.isArray(t))return console.error("‚ùå Server response is not an array:",t),y;if(t.error)return console.error("‚ùå Server returned error:",t.error),y;const s=t.map(a=>a.id),o=y.map(a=>a.id);console.log("üìä Previous chats:",o),console.log("üìä Server chats:",s);const l=y.find(a=>a.id===d);d&&l&&!s.includes(d)&&(t.push(l),console.log("üìå Preserved current chat that is not in server response"));const i=y.length;y=[...t],console.log(`üîÑ Replaced ${i} chats with ${y.length} chats from server`),console.log("üìã New activeChats array:",y.map(a=>({id:a.id,candidate:a.candidate?.name||"Unknown"})));const r=document.getElementById("chat_list_view"),m=document.getElementById("chat_messages_view");return(!d||e)&&(r&&(r.style.setProperty("display","flex","important"),r.style.setProperty("visibility","visible","important"),r.style.setProperty("opacity","1","important"),console.log("üìã Chat list view shown via loadActiveChats.")),m&&(m.style.setProperty("display","none","important"),m.style.setProperty("visibility","hidden","important"),m.style.setProperty("opacity","0","important"),console.log("üìã Chat messages view hidden via loadActiveChats.")),e&&(d=null,v=null,console.log("üìã Switched to chat list view, currentChatId cleared."))),$(y),y}).catch(t=>(console.error("‚ùå Error loading chats:",t),y))};function $(e){console.log("üìã renderChatList called with chats:",e);const t=document.getElementById("chat_list"),s=document.getElementById("chat_list_empty"),o=document.getElementById("chat_list_view");if(!t){console.error("‚ùå chat_list element not found!");return}o&&!d?(o.style.setProperty("display","flex","important"),o.style.setProperty("visibility","visible","important"),o.style.setProperty("opacity","1","important"),console.log("‚úÖ chat_list_view is now visible")):o&&d?(o.style.setProperty("display","none","important"),o.style.setProperty("visibility","hidden","important"),o.style.setProperty("opacity","0","important")):console.error("‚ùå chat_list_view element not found!"),W(),s&&(s.style.display=e.length===0?"flex":"none");const l=t.querySelectorAll(".chat-item"),i=l.length;if(l.forEach(a=>a.remove()),i>0&&console.log(`üóëÔ∏è Removed ${i} existing chat item(s) from DOM`),e.length===0){console.log("üìã No chats to display, showing empty state");return}console.log("üìã Rendering",e.length,"chats");const r=[...e].sort((a,n)=>{const p=a.last_message?new Date(a.last_message.created_at).getTime():a.updated_at?new Date(a.updated_at).getTime():0;return(n.last_message?new Date(n.last_message.created_at).getTime():n.updated_at?new Date(n.updated_at).getTime():0)-p});console.log("üìã Sorted chats:",r.map(a=>({id:a.id,latest:a.last_message?.created_at||a.updated_at||"none"}))),r.forEach((a,n)=>{const p=document.createElement("div");p.className=`chat-item p-3 border-b border-border cursor-pointer hover:bg-muted/50 ${a.id===d?"bg-muted/30":""}`,p.onclick=()=>selectChat(a.id);const f=a.candidate&&a.candidate.name?a.candidate.name:"Onbekend",u=a.last_message?a.last_message.message:"",h=a.last_message&&a.last_message.time?a.last_message.time:"";p.innerHTML=`
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center shrink-0">
                    <span class="text-primary font-semibold">${f.charAt(0).toUpperCase()}</span>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="font-semibold text-sm">${S(f)}</div>
                    ${u?`<div class="text-xs text-muted-foreground truncate">${S(u)}</div>`:'<div class="text-xs text-muted-foreground">Geen berichten</div>'}
                </div>
                ${h?`<div class="text-xs text-muted-foreground shrink-0">${h}</div>`:""}
            </div>
        `,t.appendChild(p),console.log(`‚úÖ Added chat item ${n+1} for chat ${a.id} (${f})`)});const m=t.querySelectorAll(".chat-item");console.log("‚úÖ Chat list rendered with",e.length,"items. DOM contains",m.length,"items"),console.log("üìã Chat list container after render:",{children:t.children.length,innerHTML:t.innerHTML.substring(0,200)+"..."})}function W(){fetch("/admin/chat/candidates",{headers:{"X-CSRF-TOKEN":M()}}).then(e=>e.json()).then(e=>{const t=document.getElementById("chat_candidate_select");t&&e.length>0&&(t.innerHTML='<option value="">Selecteer een kandidaat...</option>'+e.map(s=>`<option value="${s.id}" data-match-id="${s.match_id||""}">${s.name}${s.vacancy_title?" - "+s.vacancy_title:""}</option>`).join(""))}).catch(e=>{console.error("Error loading candidates:",e)})}window.handleCandidateSelect=function(){const e=document.getElementById("chat_candidate_select");if(!e||!e.value)return;const t=e.options[e.selectedIndex],s=e.value,o=t.getAttribute("data-match-id");s&&(openChatWithCandidate(s,o||null,o?"match":"application"),e.value="")};window.selectChat=function(e){if(!e){console.error("‚ùå selectChat called without chatId");return}console.log("üîµ selectChat called with chatId:",e),d=e;let t=y.find(i=>i.id===e);console.log("üîµ Found chat in activeChats:",t?"Yes":"No");const s=document.getElementById("chat_drawer"),o=document.getElementById("chat_drawer_backdrop");if(s){console.log("üîµ Setting drawer attributes..."),P=!1,s.removeAttribute("data-drawer-closed"),s.classList.remove("hidden"),w=!0;try{s.style.setProperty("display","flex","important"),s.style.setProperty("visibility","visible","important"),s.style.setProperty("opacity","1","important"),s.style.setProperty("z-index","99999","important"),s.style.setProperty("transform","translateX(0)","important"),s.style.setProperty("right","1.25rem","important"),s.style.setProperty("left","unset","important"),s.setAttribute("data-chat-active","true"),s.setAttribute("data-ignore-observer","true");const i=()=>{w=!0;try{s.style.setProperty("transform","translateX(0)","important"),s.style.setProperty("right","1.25rem","important"),s.style.setProperty("left","unset","important"),s.style.setProperty("display","flex","important"),s.style.setProperty("transition","none","important"),s.style.setProperty("animation","none","important")}finally{setTimeout(()=>{w=!1},10)}};i(),requestAnimationFrame(()=>{i(),requestAnimationFrame(()=>{i()})}),setTimeout(i,10),setTimeout(i,50),setTimeout(i,100)}finally{setTimeout(()=>{w=!1},150)}console.log("üîµ Drawer should be visible now, computed display:",window.getComputedStyle(s).display)}else console.error("‚ùå Drawer element not found in selectChat!");if(o&&(o.classList.remove("hidden"),o.style.setProperty("display","block","important"),o.style.setProperty("visibility","visible","important"),o.style.setProperty("z-index","99998","important")),!t)if(v&&v.id===e)t=v,y.findIndex(r=>r.id===e)===-1&&y.unshift(t);else{loadActiveChats().then(()=>{t=y.find(i=>i.id===e),t?(v=t,F(t),H(e),j()):(F({id:e,candidate:{name:"Loading..."}}),H(e),j())});return}v=t;const l=document.getElementById("chat_messages");l&&(console.log("üßπ Clearing messages container before switching to chat:",e),l.innerHTML=""),F(t),H(e),j()};function F(e){console.log("üü¢ updateChatViews called with chat:",e);const t=document.getElementById("chat_list_view"),s=document.getElementById("chat_messages_view"),o=document.getElementById("chat_header_name"),l=document.getElementById("chat_header_avatar"),i=document.getElementById("chat_user_avatar"),r=document.getElementById("chat_drawer"),m=document.getElementById("chat_drawer_backdrop");if(r){P=!1,r.removeAttribute("data-drawer-closed"),r.classList.remove("hidden"),w=!0;try{r.style.setProperty("display","flex","important"),r.style.setProperty("visibility","visible","important"),r.style.setProperty("opacity","1","important"),r.style.setProperty("z-index","99999","important"),r.style.setProperty("transform","translateX(0)","important"),r.style.setProperty("right","1.25rem","important"),r.style.setProperty("left","unset","important"),r.style.setProperty("transition","none","important"),r.style.setProperty("animation","none","important"),r.setAttribute("data-chat-active","true")}finally{setTimeout(()=>{w=!1},10)}console.log("üü¢ Drawer made visible in updateChatViews, computed display:",window.getComputedStyle(r).display)}m&&(m.classList.remove("hidden"),m.style.setProperty("display","block","important"),m.style.setProperty("visibility","visible","important"),m.style.setProperty("z-index","99998","important")),t?(t.style.setProperty("display","none","important"),t.style.setProperty("visibility","hidden","important"),t.style.setProperty("opacity","0","important"),console.log("üü¢ Chat list view hidden")):console.error("‚ùå chat_list_view element not found!"),s?(s.style.setProperty("display","flex","important"),s.style.setProperty("visibility","visible","important"),s.style.setProperty("opacity","1","important"),s.classList.remove("hidden"),console.log("üü¢ Chat messages view shown")):console.error("‚ùå chat_messages_view element not found!"),e&&(o&&e.candidate&&(o.textContent=e.candidate.name),l&&e.candidate&&(l.textContent=e.candidate.name.charAt(0).toUpperCase()),i&&e.user&&e.user.avatar&&(i.src=e.user.avatar)),setTimeout(()=>{K(),G();const a=document.getElementById("chat_message_input");a&&a.focus()},100)}function G(){const e=document.querySelector("#chat_messages_view .kt-scrollable-y-auto");e&&(e.removeEventListener("scroll",X),e.addEventListener("scroll",X),z())}function X(){if(q)return;const e=document.querySelector("#chat_messages_view .kt-scrollable-y-auto");if(!e)return;e.scrollHeight-e.scrollTop<=e.clientHeight+50?B=!1:B=!0,z()}window.showChatList=function(){console.log("üìã showChatList called");const e=document.getElementById("chat_list_view"),t=document.getElementById("chat_messages_view");d=null,v=null,N&&clearInterval(N),R&&clearInterval(R),t&&(t.style.display="none",t.style.visibility="hidden"),e&&(e.style.display="flex",e.style.visibility="visible",e.style.opacity="1"),loadActiveChats().then(()=>{$(y)})};function K(){const e=document.getElementById("chat_message_input");if(!e){console.warn("‚ö†Ô∏è Chat input not found, will retry...");return}const t=e.cloneNode(!0);e.parentNode.replaceChild(t,e);const s=function(){t.style.height="auto",t.style.height=Math.min(t.scrollHeight,200)+"px"};t.addEventListener("keypress",function(l){l.key==="Enter"&&!l.shiftKey?(l.preventDefault(),console.log("‚å®Ô∏è Enter key pressed, calling sendMessage"),window.sendMessage?window.sendMessage():console.error("‚ùå sendMessage function not found!")):onChatMessageInput&&onChatMessageInput()}),t.addEventListener("input",function(){s(),onChatMessageInput&&onChatMessageInput()}),s(),setTimeout(()=>{t.focus()},50);const o=document.getElementById("chat_send_button");o&&!o.hasAttribute("data-send-listener-added")?(o.setAttribute("data-send-listener-added","true"),o.addEventListener("click",function(l){l.preventDefault(),l.stopPropagation(),console.log("üîµ Send button clicked via event listener"),window.sendMessage?window.sendMessage():console.error("‚ùå sendMessage function not found!")}),console.log("‚úÖ Send button event listener added")):o||console.warn("‚ö†Ô∏è Send button not found!"),console.log("‚úÖ Chat input event listeners initialized")}function H(e){if(console.log("üì• Loading messages for chat:",e),d!==e){const t=document.getElementById("chat_messages");t&&(console.log("üßπ Clearing messages container for new chat"),t.innerHTML="")}return fetch(`/admin/chat/${e}/messages`,{headers:{"X-CSRF-TOKEN":M()}}).then(t=>{if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return t.json()}).then(t=>(console.log("‚úÖ Messages loaded:",t),Array.isArray(t)?d===e?(Y(t,e),setTimeout(()=>{A()},100)):console.log("‚è≠Ô∏è Skipping render - chat changed from",e,"to",d):console.error("‚ùå Messages is not an array:",t),t)).catch(t=>{throw console.error("‚ùå Error loading messages:",t),t})}function k(){const e=document.getElementById("chat_messages");if(!e)return;const t=Array.from(e.querySelectorAll(".flex.items-end"));if(t.length===0)return;const s=t.map(o=>{const l=o.getAttribute("data-timestamp");let i=null;if(l)i=new Date(l);else{const r=o.querySelector(".text-xs.font-medium");if(r){const m=r.textContent.trim(),a=new Date,[n,p]=m.split(":").map(Number);!isNaN(n)&&!isNaN(p)&&(i=new Date(a.getFullYear(),a.getMonth(),a.getDate(),n,p))}i||(i=new Date)}return{element:o,timestamp:i}});s.sort((o,l)=>o.timestamp.getTime()-l.timestamp.getTime()),s.forEach(({element:o})=>{e.appendChild(o)})}function Y(e,t=null){console.log("üé® Rendering messages:",e,"for chat:",t||d);const s=document.getElementById("chat_messages");if(!s){console.error("‚ùå Messages container not found!");return}if(t!==null&&t!==d){console.log("‚è≠Ô∏è Skipping render - chat mismatch. Expected:",t,"Current:",d);return}const o=s.querySelectorAll('[data-optimistic="false"]');console.log("üßπ Removing",o.length,"existing real messages"),o.forEach(c=>c.remove());const l=Array.from(s.querySelectorAll('[data-optimistic="true"]')),i=l.map(c=>{const b=c.getAttribute("data-message-text")||c.querySelector(".kt-card p")?.textContent||"",g=c.getAttribute("data-optimistic-id"),E=c.getAttribute("data-timestamp"),x=c.getAttribute("data-chat-id");return x&&x!==String(d)?(console.log("üóëÔ∏è Removing optimistic message from different chat:",x,"current:",d),c.remove(),null):{element:c,text:b,id:g,timestamp:E?new Date(E):new Date}}).filter(c=>c!==null),r=Array.isArray(e)&&e.length>0,m=l.length>0,a=r||m;let n=s.querySelector(".chat-empty-message");if(a?n&&n.remove():n||(n=document.createElement("div"),n.className="chat-empty-message text-center text-muted-foreground p-4",n.textContent="Geen berichten",s.appendChild(n)),!r)return void 0;const p=new Set,f=new Map;Array.from(s.querySelectorAll(".flex.items-end")).forEach(c=>{if(!(c.getAttribute("data-optimistic")==="true")){const g=c.getAttribute("data-message-id");g&&(p.add(g),f.set(g,c))}}),new Set(i.map(({text:c})=>c));const h=e.filter(c=>!(c.id&&p.has(String(c.id))));if(h.length===0){console.log("‚úÖ No new messages to render, all messages already exist or are optimistic"),i.forEach(({element:E,text:x,timestamp:L})=>{if(!x||!L)return;const I=e.filter(C=>C.message===x);if(I.length===0)return;let _=null,O=1/0;if(I.forEach(C=>{if(C.created_at){const U=new Date(C.created_at),V=Math.abs(U.getTime()-L.getTime());V<O&&(O=V,_=C)}}),_&&O<5e3){const C=s.querySelector(`[data-optimistic="false"][data-message-id="${_.id}"]`);C&&C.offsetParent!==null?(console.log("üîÑ Removing optimistic message, matching real message exists in DOM:",x,"ID:",_.id),E.remove(),k()):console.log("‚è≥ Keeping optimistic message, real message not yet in DOM or visible:",x)}}),k();const b=s.querySelectorAll(".flex.items-end").length>0;let g=s.querySelector(".chat-empty-message");b?g&&g.remove():g||(g=document.createElement("div"),g.className="chat-empty-message text-center text-muted-foreground p-4",g.textContent="Geen berichten",s.appendChild(g)),A();return}const T=h.map(c=>{const b=c.is_own;if(c.sender_name&&c.sender_name.charAt(0).toUpperCase(),b){const g=v&&v.user&&v.user.avatar?v.user.avatar:"/assets/media/avatars/300-2.png",E=c.created_at?new Date(c.created_at).toISOString():new Date().toISOString();return`
                <div class="flex items-end justify-end gap-3.5 px-5" data-optimistic="false" data-message-id="${c.id||""}" data-message-text="${S(c.message)}" data-timestamp="${E}" data-chat-id="${d||""}">
                    <div class="flex flex-col gap-1.5">
                        <div class="kt-card bg-primary rounded-be-none flex flex-col gap-2.5 p-3 shadow-none">
                            <p class="text-2sm text-primary-foreground font-medium">${S(c.message)}</p>
                        </div>
                        <div class="relative flex items-center justify-end gap-2">
                            <span class="text-xs font-medium text-secondary-foreground">${c.time}</span>
                            <i class="ki-filled ki-double-check absolute text-lg ${c.is_read?"text-green-500":"text-gray-400"}"></i>
                        </div>
                    </div>
                    <div class="relative shrink-0">
                        <div class="kt-avatar size-9">
                            <div class="kt-avatar-image">
                                <img alt="${c.sender_name}" class="size-9 rounded-full object-cover" src="${g}" />
                            </div>
                            <div class="kt-avatar-indicator -bottom-2 -end-2">
                                <div class="kt-avatar-status kt-avatar-status-online size-2.5"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `}else{const g=c.sender_avatar||"/assets/media/avatars/300-5.png",E=c.created_at?new Date(c.created_at).toISOString():new Date().toISOString();return`
                <div class="flex items-end gap-3.5 px-5" data-optimistic="false" data-message-id="${c.id||""}" data-message-text="${S(c.message)}" data-timestamp="${E}" data-chat-id="${d||""}">
                    <img alt="${c.sender_name}" class="size-9 rounded-full object-cover" src="${g}" />
                    <div class="flex flex-col gap-1.5">
                        <div class="kt-card bg-accent/60 rounded-bs-none text-2sm flex flex-col gap-2.5 p-3 shadow-none">
                            ${S(c.message)}
                        </div>
                        <span class="text-xs font-medium text-muted-foreground">${c.time}</span>
                    </div>
                </div>
            `}}).join("");T&&s.insertAdjacentHTML("beforeend",T),k(),A(),i.forEach(({element:c,text:b,timestamp:g,id:E})=>{if(!c||!c.parentNode||!b||!g)return;const x=e.filter(_=>_.message===b);if(x.length===0){console.log("‚è≥ Keeping optimistic message, no matching message in response yet:",b);return}let L=null,I=1/0;x.forEach(_=>{if(_.created_at){const O=new Date(_.created_at),C=Math.abs(O.getTime()-g.getTime());C<I&&(I=C,L=_)}}),L&&I<5e3?setTimeout(()=>{if(c&&c.parentNode){const _=s.querySelector(`[data-optimistic="false"][data-message-id="${L.id}"]`);_&&_.offsetParent!==null?(console.log("üîÑ Removing optimistic message, matching real message exists in DOM:",b,"ID:",L.id,"timeDiff:",I),c.remove(),k(),A()):console.log("‚è≥ Keeping optimistic message, real message not yet visible:",b)}},150):console.log("‚è≥ Keeping optimistic message, no close timestamp match found:",b,"closestTimeDiff:",I)}),console.log("‚úÖ Messages rendered, count:",e.length,"new messages:",h.length,"optimistic preserved:",i.length,"container:",s),requestAnimationFrame(()=>{const b=s.querySelectorAll(".flex.items-end").length>0;let g=s.querySelector(".chat-empty-message");b?g&&g.remove():g||(g=document.createElement("div"),g.className="chat-empty-message text-center text-muted-foreground p-4",g.textContent="Geen berichten",s.appendChild(g))})}function J(e,t=!1){const s=document.getElementById("chat_messages");if(!s)return console.error("‚ùå Messages container not found!"),null;const o=s.querySelector(".chat-empty-message");o&&o.remove();const l=v&&v.user&&v.user.avatar?v.user.avatar:"/assets/media/avatars/300-2.png",i=new Date,r=i.toLocaleTimeString("nl-NL",{hour:"2-digit",minute:"2-digit"}),m=i.toISOString(),a=t?`optimistic-${Date.now()}-${Math.random().toString(36).substr(2,9)}`:null,n=document.createElement("div");return n.className="flex items-end justify-end gap-3.5 px-5",n.setAttribute("data-optimistic",t?"true":"false"),n.setAttribute("data-message-text",S(e)),n.setAttribute("data-timestamp",m),n.setAttribute("data-chat-id",String(d||"")),a&&n.setAttribute("data-optimistic-id",a),n.innerHTML=`
        <div class="flex flex-col gap-1.5">
            <div class="kt-card bg-primary rounded-be-none flex flex-col gap-2.5 p-3 shadow-none">
                <p class="text-2sm text-primary-foreground font-medium">${S(e)}</p>
            </div>
            <div class="relative flex items-center justify-end gap-2">
                <span class="text-xs font-medium text-secondary-foreground">${r}</span>
                ${t?'<i class="ki-filled ki-time text-lg text-gray-400"></i>':'<i class="ki-filled ki-double-check absolute text-lg text-gray-400"></i>'}
            </div>
        </div>
        <div class="relative shrink-0">
            <div class="kt-avatar size-9">
                <div class="kt-avatar-image">
                    <img alt="You" class="size-9 rounded-full object-cover" src="${l}" />
                </div>
                <div class="kt-avatar-indicator -bottom-2 -end-2">
                    <div class="kt-avatar-status kt-avatar-status-online size-2.5"></div>
                </div>
            </div>
        </div>
    `,s.appendChild(n),k(),A(),n}window.sendMessage=function(){console.log("üîµ sendMessage called");const e=document.getElementById("chat_message_input");if(!e){console.error("‚ùå Chat input element not found!");return}if(!e.value||!e.value.trim()){console.warn("‚ö†Ô∏è Cannot send message: input is empty");return}if(!d){console.warn("‚ö†Ô∏è Cannot send message: no chat selected, currentChatId:",d);return}const t=e.value.trim();console.log("üì§ Sending message:",t,"to chat:",d);const s=J(t,!0);e.value="",e.style&&(e.style.height="auto");const o=new FormData;o.append("message",t);const l=M();if(!l){console.error("‚ùå CSRF token not found!"),s&&s.remove(),e.value=t;return}fetch(`/admin/chat/${d}/message`,{method:"POST",headers:{"X-CSRF-TOKEN":l,Accept:"application/json"},body:o}).then(i=>(console.log("üì° Response status:",i.status),i.ok?i.json():i.text().then(r=>{throw console.error("‚ùå Response error:",r),new Error(`HTTP error! status: ${i.status}, body: ${r}`)}))).then(i=>{if(console.log("‚úÖ Message sent successfully:",i),i.success&&i.message){const r=document.getElementById("chat_messages");let m=!1;if(r)if(i.message.id?r.querySelector(`[data-optimistic="false"][data-message-id="${i.message.id}"]`):null)s&&s.remove();else{const n=v&&v.user&&v.user.avatar?v.user.avatar:"/assets/media/avatars/300-2.png",p=i.message.created_at?new Date(i.message.created_at).toISOString():new Date().toISOString(),f=`
                        <div class="flex items-end justify-end gap-3.5 px-5" data-optimistic="false" data-message-id="${i.message.id||""}" data-message-text="${S(i.message.message)}" data-timestamp="${p}" data-chat-id="${d||""}">
                            <div class="flex flex-col gap-1.5">
                                <div class="kt-card bg-primary rounded-be-none flex flex-col gap-2.5 p-3 shadow-none">
                                    <p class="text-2sm text-primary-foreground font-medium">${S(i.message.message)}</p>
                                </div>
                                <div class="relative flex items-center justify-end gap-2">
                                    <span class="text-xs font-medium text-secondary-foreground">${i.message.time}</span>
                                    <i class="ki-filled ki-double-check absolute text-lg ${i.message.is_read?"text-green-500":"text-gray-400"}"></i>
                                </div>
                            </div>
                            <div class="relative shrink-0">
                                <div class="kt-avatar size-9">
                                    <div class="kt-avatar-image">
                                        <img alt="${i.message.sender_name}" class="size-9 rounded-full object-cover" src="${n}" />
                                    </div>
                                    <div class="kt-avatar-indicator -bottom-2 -end-2">
                                        <div class="kt-avatar-status kt-avatar-status-online size-2.5"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;r.insertAdjacentHTML("beforeend",f),m=!0,k(),A(),requestAnimationFrame(()=>{const u=r.querySelector(`[data-optimistic="false"][data-message-id="${i.message.id||""}"]`);u&&u.offsetParent!==null?s&&s.parentNode&&(console.log("üîÑ Removing optimistic message, real message confirmed in DOM"),s.remove(),k(),A()):(console.log("‚è≥ Keeping optimistic message, real message not yet visible"),setTimeout(()=>{const h=r.querySelector(`[data-optimistic="false"][data-message-id="${i.message.id||""}"]`);h&&h.offsetParent!==null&&s&&s.parentNode&&(s.remove(),k(),A())},50))}),A()}if(v&&i.message){v.last_message={message:i.message.message,created_at:i.message.created_at,time:i.message.time};const a=y.findIndex(n=>n.id===d);a!==-1&&(y[a].last_message=v.last_message,y[a].updated_at=i.message.created_at||new Date().toISOString())}m&&(setTimeout(()=>{H(d)},500),setTimeout(()=>{const a=document.getElementById("chat_list_view");a&&window.getComputedStyle(a).display!=="none"?($(y),loadActiveChats(!1).then(()=>{$(y)})):loadActiveChats(!1)},600))}else console.error("‚ùå Message send failed:",i),s&&s.remove(),e.value=t}).catch(i=>{console.error("‚ùå Error sending message:",i),s&&s.remove(),e.value=t})};window.handleDrawerClose=function(){const e=document.getElementById("chat_drawer"),t=document.getElementById("chat_drawer_backdrop");if(!e)return;console.log("üîí handleDrawerClose called - closing drawer"),P=!0,d=null,v=null;const s=()=>{e&&(e.setAttribute("data-drawer-closed","true"),e.removeAttribute("style"),e.classList.add("hidden"),e.removeAttribute("data-chat-active"),e.style.cssText="display: none !important; visibility: hidden !important; opacity: 0 !important; transform: translateX(100%) !important; right: -100% !important; left: unset !important; z-index: -1 !important;",e.classList.remove("open"))},o=()=>{t&&(t.removeAttribute("style"),t.classList.add("hidden"),t.style.cssText="display: none !important; visibility: hidden !important; opacity: 0 !important; z-index: -1 !important;")};if(window.KTDrawer){const a=window.KTDrawer.getInstance(e);if(a)try{a.hide()}catch(n){console.log("‚ö†Ô∏è Error hiding drawer instance:",n)}}const l=document.querySelector('[data-kt-drawer-toggle="#chat_drawer"]');if(l&&(!e.classList.contains("hidden")||window.getComputedStyle(e).display!=="none"))try{l.click()}catch(n){console.log("‚ö†Ô∏è Error clicking toggle:",n)}s(),o(),[0,10,50,100,200,300,500,1e3].forEach(a=>{setTimeout(()=>{s(),o()},a)});let r=0;const m=setInterval(()=>{e&&P?(s(),o(),r++,r>=30&&clearInterval(m)):clearInterval(m)},100)};window.endChat=function(){d&&confirm("Weet je zeker dat je deze chat wilt be√´indigen?")&&fetch(`/admin/chat/${d}/end`,{method:"POST",headers:{"X-CSRF-TOKEN":M()}}).then(e=>e.json()).then(e=>{if(e.success){d=null,v=null;const t=document.getElementById("chat_drawer");t&&t.removeAttribute("data-chat-active"),loadActiveChats();const s=document.getElementById("chat_messages");s&&(s.innerHTML=""),showChatList()}}).catch(e=>{console.error("Error ending chat:",e)})};function j(e){R&&clearInterval(R),N&&clearInterval(N),R=setInterval(()=>{d&&H(d)},500),N=setInterval(()=>{d&&Q(d)},1e3)}function Q(e){fetch(`/admin/chat/${e}/typing`,{headers:{"X-CSRF-TOKEN":M()}}).then(t=>t.json()).then(t=>{const s=document.getElementById("chat_typing_indicator_header");if(s)if(t.length>0){const o=t.map(l=>l.name).join(", ");s.textContent=`${o} ${t.length===1?"is":"zijn"} aan het typen...`,s.style.display="block"}else s.style.display="none"}).catch(t=>{console.error("Error checking typing:",t)})}window.onChatMessageInput=function(){!document.getElementById("chat_message_input")||!d||fetch(`/admin/chat/${d}/typing`,{method:"POST",headers:{"X-CSRF-TOKEN":M()}})};function A(e=!1){if(!e&&B){z();return}requestAnimationFrame(()=>{const t=document.getElementById("chat_messages");if(t){const s=t.closest(".kt-scrollable-y-auto");s?(q=!0,s.scrollTop=s.scrollHeight,setTimeout(()=>{q=!1,B=!1,z()},100)):(q=!0,t.scrollTop=t.scrollHeight,setTimeout(()=>{q=!1,B=!1,z()},100))}})}function z(){const e=document.querySelector("#chat_messages_view .kt-scrollable-y-auto"),t=document.getElementById("scroll_to_bottom_btn");if(!e||!t)return;e.scrollHeight-e.scrollTop<=e.clientHeight+50?t.style.display="none":t.style.display="flex"}window.scrollToBottomManually=function(){B=!1,A(!0)};function S(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("chat_drawer"),t=document.getElementById("chat_drawer_backdrop");e&&(e.classList.add("hidden"),e.style.display="none",e.style.visibility="hidden",e.style.opacity="0"),t&&(t.classList.add("hidden"),t.style.display="none",t.style.visibility="hidden"),e&&(new MutationObserver(function(r){r.forEach(function(m){if(m.type==="attributes"&&m.attributeName==="class"){if(e&&e.getAttribute("data-ignore-observer")==="true"){console.log("‚è≠Ô∏è Observer skipped - ignore flag set");return}if(P||e&&e.getAttribute("data-drawer-closed")==="true"){console.log("‚è≠Ô∏è Observer skipped - drawer explicitly closed");return}const a=!e.classList.contains("hidden");if(console.log("üëÅÔ∏è Observer detected drawer state change, isOpen:",a,"currentChatId:",d),a){if(D){console.log("‚è≠Ô∏è Observer skipped - isOpeningChat flag set");return}if(w)return;w=!0;try{e.style.setProperty("display","flex","important"),e.style.setProperty("visibility","visible","important"),e.style.setProperty("opacity","1","important"),e.style.setProperty("z-index","99999","important"),e.style.setProperty("transform","translateX(0)","important"),e.style.setProperty("right","1.25rem","important"),e.style.setProperty("left","unset","important"),t.style.setProperty("display","block","important"),t.style.setProperty("visibility","visible","important"),t.style.setProperty("z-index","99998","important")}finally{setTimeout(()=>{w=!1},10)}t&&t.classList.remove("hidden");const n=document.getElementById("chat_list_view"),p=document.getElementById("chat_messages_view");d?(n&&(n.style.setProperty("display","none","important"),n.style.setProperty("visibility","hidden","important"),n.style.setProperty("opacity","0","important")),p&&(p.style.setProperty("display","flex","important"),p.style.setProperty("visibility","visible","important"),p.style.setProperty("opacity","1","important"),p.classList.remove("hidden"))):(n&&(n.style.setProperty("display","flex","important"),n.style.setProperty("visibility","visible","important"),n.style.setProperty("opacity","1","important")),p&&(p.style.setProperty("display","none","important"),p.style.setProperty("visibility","hidden","important"),p.style.setProperty("opacity","0","important"))),loadActiveChats().then(()=>{d||$(y)}),setTimeout(()=>{const f=document.getElementById("chat_candidate_select");f&&!f.hasAttribute("data-listener-attached")&&(f.addEventListener("change",handleCandidateSelect),f.setAttribute("data-listener-attached","true"))},100)}else if(d||D||e?.getAttribute("data-chat-active")==="true"){if(e&&(e.classList.remove("hidden"),!w)){w=!0;try{e.style.setProperty("display","flex","important"),e.style.setProperty("visibility","visible","important"),e.style.setProperty("opacity","1","important"),e.style.setProperty("z-index","99999","important"),e.style.setProperty("transform","translateX(0)","important"),e.style.setProperty("right","1.25rem","important"),e.style.setProperty("left","unset","important"),e.setAttribute("data-chat-active","true")}finally{setTimeout(()=>{w=!1},10)}}t&&(t.classList.remove("hidden"),t.style.display="block",t.style.visibility="visible")}else e&&(e.removeAttribute("data-chat-active"),e.style.display="none",e.style.visibility="hidden",e.style.opacity="0"),t&&(t.classList.add("hidden"),t.style.display="none",t.style.visibility="hidden")}})}).observe(e,{attributes:!0,attributeFilter:["class"]}),new MutationObserver(function(r){w||P||e&&e.getAttribute("data-drawer-closed")==="true"||e&&e.getAttribute("data-chat-active")==="true"&&requestAnimationFrame(()=>{if(w)return;const m=window.getComputedStyle(e).transform,a=window.getComputedStyle(e).right,n=window.getComputedStyle(e).left,p=m!=="none"&&m!=="matrix(1, 0, 0, 1, 0, 0)",f=a!=="1.25rem"&&a!=="20px",u=n!=="auto"&&n!=="unset";if(p||f||u){w=!0;try{if(p&&(console.log("üîÑ Style observer: Resetting transform from",m),e.style.setProperty("transform","translateX(0)","important")),f&&(console.log("üîÑ Style observer: Resetting right from",a),e.style.setProperty("right","1.25rem","important")),u){console.log("üîÑ Style observer: Resetting left from",n),e.style.left&&e.style.removeProperty("left");const h=e.getAttribute("style");if(h){const T=h.replace(/left\s*:\s*[^;!]+(!important)?;?/gi,"").trim();T!==h&&e.setAttribute("style",T)}e.style.setProperty("left","unset","important")}}finally{setTimeout(()=>{w=!1},50)}}})}).observe(e,{attributes:!0,attributeFilter:["style","class"],attributeOldValue:!1,childList:!1,subtree:!1}),setInterval(function(){if(w)return;if(P||e&&e.getAttribute("data-drawer-closed")==="true"){e&&(e.setAttribute("data-drawer-closed","true"),e.classList.add("hidden"),e.removeAttribute("data-chat-active"),e.style.setProperty("display","none","important"),e.style.setProperty("visibility","hidden","important"),e.style.setProperty("opacity","0","important"),e.style.setProperty("transform","translateX(100%)","important"),e.style.setProperty("right","-100%","important"),e.style.setProperty("z-index","-1","important"),e.classList.remove("open")),t&&(t.classList.add("hidden"),t.style.setProperty("display","none","important"),t.style.setProperty("visibility","hidden","important"),t.style.setProperty("opacity","0","important"),t.style.setProperty("z-index","-1","important"));return}const r=d||D||e&&e.getAttribute("data-chat-active")==="true";if(r&&e){const m=e.classList.contains("hidden"),a=window.getComputedStyle(e).display;(m||a==="none")&&(console.log("üîÑ Interval: Drawer was hidden, reopening...",{isMarkedHidden:m,computedDisplay:a}),e.classList.remove("hidden")),w=!0;try{e.style.setProperty("display","flex","important"),e.style.setProperty("visibility","visible","important"),e.style.setProperty("opacity","1","important"),e.style.setProperty("z-index","99999","important"),e.style.setProperty("transform","translateX(0)","important"),e.style.setProperty("right","1.25rem","important"),e.setAttribute("data-chat-active","true"),e.style.left&&e.style.removeProperty("left");const u=e.getAttribute("style");if(u){const h=u.replace(/left\s*:\s*[^;!]+(!important)?;?/gi,"").trim();h!==u&&e.setAttribute("style",h)}e.style.setProperty("left","unset","important"),e.style.setProperty("transition","none","important"),e.style.setProperty("animation","none","important")}finally{setTimeout(()=>{w=!1},10)}const n=window.getComputedStyle(e).transform,p=window.getComputedStyle(e).right,f=window.getComputedStyle(e).left;if(n!=="none"&&n!=="matrix(1, 0, 0, 1, 0, 0)"&&e.style.setProperty("transform","translateX(0)","important"),p!=="1.25rem"&&p!=="20px"&&e.style.setProperty("right","1.25rem","important"),f!=="unset"&&f!=="auto"){e.style.left&&e.style.removeProperty("left");const u=e.getAttribute("style");if(u){const h=u.replace(/left\s*:\s*[^;!]+(!important)?;?/gi,"").trim();h!==u&&e.setAttribute("style",h)}e.style.setProperty("left","unset","important")}t&&(t.classList.remove("hidden"),t.style.setProperty("display","block","important"),t.style.setProperty("visibility","visible","important"),t.style.setProperty("z-index","99998","important"))}else!r&&e&&e.getAttribute("data-chat-active")==="true"&&(console.log("üîÑ Interval: No active chat, removing active flag"),e.removeAttribute("data-chat-active"))},10)),t&&t.addEventListener("click",function(){window.handleDrawerClose&&window.handleDrawerClose()});const s=document.querySelector('[data-kt-drawer-toggle="#chat_drawer"]');s&&s.addEventListener("click",function(l){e&&(e.classList.contains("hidden")||window.getComputedStyle(e).display==="none")?(P=!1,e&&e.removeAttribute("data-drawer-closed"),console.log("üîì Toggle button clicked - resetting close flag to allow drawer to open")):(P=!0,e&&e.setAttribute("data-drawer-closed","true"),console.log("üîí Toggle button clicked - setting close flag")),setTimeout(()=>{e&&(e.classList.contains("hidden")||window.getComputedStyle(e).display==="none")?(P=!0,e&&e.setAttribute("data-drawer-closed","true")):(P=!1,e&&e.removeAttribute("data-drawer-closed"))},50);const r=()=>{e&&(e.classList.remove("hidden"),e.style.setProperty("display","flex","important"),e.style.setProperty("visibility","visible","important"),e.style.setProperty("opacity","1","important"),e.style.setProperty("z-index","99999","important"),e.style.setProperty("transform","translateX(0)","important"),e.style.setProperty("right","1.25rem","important"),e.style.setProperty("left","unset","important"),e.style.setProperty("transition","none","important"),e.style.setProperty("animation","none","important")),t&&(t.classList.remove("hidden"),t.style.setProperty("display","block","important"),t.style.setProperty("visibility","visible","important"),t.style.setProperty("z-index","99998","important"))};r(),requestAnimationFrame(()=>{r(),requestAnimationFrame(()=>{r()})}),setTimeout(r,10),setTimeout(r,50),setTimeout(r,100),setTimeout(r,200)}),e&&e.querySelectorAll('[data-kt-drawer-dismiss="true"]').forEach(i=>{i.addEventListener("click",function(r){r.preventDefault(),r.stopPropagation(),window.handleDrawerClose&&window.handleDrawerClose()})});const o=document.getElementById("chat_candidate_select");o&&o.addEventListener("change",handleCandidateSelect),setTimeout(()=>{K()},500),document.addEventListener("keydown",function(l){if(l.key==="Escape"||l.keyCode===27){const i=document.getElementById("chat_drawer");if(i&&window.getComputedStyle(i).display!=="none"&&!i.classList.contains("hidden"))if(l.preventDefault(),l.stopPropagation(),l.stopImmediatePropagation(),console.log("‚å®Ô∏è ESC key pressed - closing drawer"),window.handleDrawerClose)window.handleDrawerClose();else{i.classList.add("hidden"),i.style.cssText="display: none !important; visibility: hidden !important; opacity: 0 !important;";const a=document.getElementById("chat_drawer_backdrop");a&&(a.classList.add("hidden"),a.style.cssText="display: none !important; visibility: hidden !important; opacity: 0 !important;")}}},!0),document.addEventListener("click",function(l){const i=document.getElementById("chat_drawer"),r=document.getElementById("chat_drawer_backdrop");if(!i||P||i.getAttribute("data-drawer-closed")==="true"||!(window.getComputedStyle(i).display!=="none"&&!i.classList.contains("hidden")))return;const n=l.target,p=i.contains(n);r&&(r===n||r.contains(n));const f=n.closest('[data-kt-drawer-toggle="#chat_drawer"]');!p&&!f&&(console.log("üñ±Ô∏è Click outside drawer - closing drawer"),window.handleDrawerClose&&window.handleDrawerClose())})});
