import"./frontend-app-B6vhmd6y.js";console.log("üì¶ chat.js loaded!");let f=[],m=null,N=null,q=null,v=null,D=!1,w=!1,P=!1,$=!1,z=!1;window.openChatWithCandidate=function(e,t,s){if(console.log("üöÄ openChatWithCandidate called!",{candidateId:e,matchOrAppId:t,type:s}),!e){console.error("‚ùå No candidateId provided!");return}P=!1;const o=document.getElementById("chat_drawer"),l=document.getElementById("chat_drawer_backdrop");o&&o.removeAttribute("data-drawer-closed");const a=document.querySelector('[data-kt-drawer-toggle="#chat_drawer"]');if(a)a.click();else if(o){const n=window.KTDrawer?.getInstance?.(o);n?n.show():o.classList.remove("hidden")}const r=new FormData;r.append("candidate_id",e),t&&t!=="null"&&t!==null&&s&&s!=="null"&&s!==""&&(s==="match"?r.append("match_id",t):s==="application"&&r.append("application_id",t)),D=!0;const c=document.getElementById("chat_list_view"),i=document.getElementById("chat_messages_view");c&&(c.style.setProperty("display","none","important"),c.style.setProperty("visibility","hidden","important"),c.style.setProperty("opacity","0","important")),i&&(i.style.setProperty("display","flex","important"),i.style.setProperty("visibility","visible","important"),i.style.setProperty("opacity","1","important"),i.classList.remove("hidden")),setTimeout(()=>{fetch("/admin/chat/start",{method:"POST",headers:{"X-CSRF-TOKEN":M()},body:r}).then(n=>n.json()).then(n=>{if(n.success){if(console.log("‚úÖ Chat started successfully:",n.chat_id),D=!0,m=n.chat_id,n.chat){const u=f.findIndex(h=>h.id===n.chat.id);u===-1?f.unshift(n.chat):f[u]=n.chat,v=n.chat,console.log("‚úÖ Chat added to activeChats:",n.chat)}if(o){o.setAttribute("data-chat-active","true"),o.setAttribute("data-ignore-observer","true");const u=()=>{w=!0;try{o.style.setProperty("transform","translateX(0)","important"),o.style.setProperty("right","1.25rem","important"),o.style.setProperty("left","unset","important"),o.style.setProperty("display","flex","important"),o.style.setProperty("transition","none","important"),o.style.setProperty("animation","none","important"),o.style.left&&o.style.removeProperty("left");const h=o.getAttribute("style");if(h){const A=h.replace(/left\s*:\s*[^;!]+(!important)?;?/gi,"").trim();A!==h&&o.setAttribute("style",A)}o.style.setProperty("left","unset","important")}finally{setTimeout(()=>{w=!1},10)}};u(),requestAnimationFrame(()=>{u(),requestAnimationFrame(()=>{u()})}),setTimeout(u,10),setTimeout(u,50),setTimeout(u,100),setTimeout(u,200),setTimeout(u,300)}l&&l.classList.remove("hidden");const p=document.getElementById("chat_list_view"),y=document.getElementById("chat_messages_view");if(p&&(p.style.setProperty("display","none","important"),p.style.setProperty("visibility","hidden","important"),p.style.setProperty("opacity","0","important")),y&&(y.style.setProperty("display","flex","important"),y.style.setProperty("visibility","visible","important"),y.style.setProperty("opacity","1","important"),y.classList.remove("hidden")),console.log("‚úÖ Selecting chat:",n.chat_id),selectChat(n.chat_id),setTimeout(()=>{o&&(o.removeAttribute("data-ignore-observer"),console.log("‚úÖ Removed ignore-observer flag"))},2e3),n.chat){const u=f.findIndex(h=>h.id===n.chat.id);u===-1?f.unshift(n.chat):f[u]=n.chat,m===n.chat.id&&(v=n.chat)}setTimeout(()=>{loadActiveChats(!1).then(()=>{const u=document.getElementById("chat_list_view");u&&window.getComputedStyle(u).display!=="none"&&B(f)})},500),setTimeout(()=>{D=!1},3e3)}}).catch(n=>{console.error("Error starting chat:",n),D=!1})},100)};function M(){return document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||""}window.loadActiveChats=function(e=!1){return console.log("üìã loadActiveChats called, showListView:",e),fetch("/admin/chat/active",{headers:{"X-CSRF-TOKEN":M()},cache:"no-cache"}).then(t=>{if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return t.json()}).then(t=>{if(console.log("‚úÖ Active chats loaded from server:",t),console.log("üìä Server returned",t.length,"chats"),!Array.isArray(t))return console.error("‚ùå Server response is not an array:",t),f;if(t.error)return console.error("‚ùå Server returned error:",t.error),f;const s=t.map(i=>i.id),o=f.map(i=>i.id);console.log("üìä Previous chats:",o),console.log("üìä Server chats:",s),t.forEach(i=>{const n=f.find(p=>p.id===i.id);if(n&&n.unread_count!==void 0){const p=i.unread_count||0,y=n.unread_count||0;i.unread_count=Math.max(p,y),y>p&&console.log("üìå Preserved unread count for chat",i.id,":",y,"(server had:",p,")")}});const l=f.find(i=>i.id===m);m&&l&&!s.includes(m)&&(t.push(l),console.log("üìå Preserved current chat that is not in server response"));const a=f.length;f=[...t],console.log(`üîÑ Replaced ${a} chats with ${f.length} chats from server`),console.log("üìã New activeChats array:",f.map(i=>({id:i.id,candidate:i.candidate?.name||"Unknown"})));const r=document.getElementById("chat_list_view"),c=document.getElementById("chat_messages_view");return(!m||e)&&(r&&(r.style.setProperty("display","flex","important"),r.style.setProperty("visibility","visible","important"),r.style.setProperty("opacity","1","important"),console.log("üìã Chat list view shown via loadActiveChats.")),c&&(c.style.setProperty("display","none","important"),c.style.setProperty("visibility","hidden","important"),c.style.setProperty("opacity","0","important"),console.log("üìã Chat messages view hidden via loadActiveChats.")),e&&(m=null,v=null,console.log("üìã Switched to chat list view, currentChatId cleared."))),B(f),f}).catch(t=>(console.error("‚ùå Error loading chats:",t),f))};function K(e){const t=document.getElementById("chat_list");t&&e.forEach(s=>{const o=t.querySelector(`.chat-item[data-chat-id="${s.id}"]`);if(!o)return;const l=s.unread_count||0,a=o.querySelector(".bg-accent\\/60.size-11, .bg-accent\\/60");if(!a)return;const r=a.querySelector(".absolute.top-0.end-0");if(r&&r.remove(),l>0){const c=document.createElement("span");c.className="absolute top-0 end-0 flex items-center justify-center w-[18px] h-[18px] rounded-full bg-red-500 text-white text-[10px] font-semibold leading-none z-10",c.style.boxSizing="border-box",c.style.backgroundColor="rgb(239, 68, 68)",c.style.color="white",c.style.display="flex",c.style.visibility="visible",c.style.opacity="1",c.style.position="absolute",c.style.top="-2px",c.style.right="-2px",c.style.zIndex="10",c.style.width="18px",c.style.height="18px",c.style.borderRadius="50%",c.style.transform="none",c.textContent=l>9?"9+":l.toString(),a.appendChild(c),console.log("‚úÖ Added badge to chat",s.id,"with unread count:",l)}})}function B(e){console.log("üìã renderChatList called with chats:",e);const t=document.getElementById("chat_list"),s=document.getElementById("chat_list_empty"),o=document.getElementById("chat_list_view");if(!t){console.error("‚ùå chat_list element not found!");return}o&&!m?(o.style.setProperty("display","flex","important"),o.style.setProperty("visibility","visible","important"),o.style.setProperty("opacity","1","important"),console.log("‚úÖ chat_list_view is now visible")):o&&m?(o.style.setProperty("display","none","important"),o.style.setProperty("visibility","hidden","important"),o.style.setProperty("opacity","0","important")):console.error("‚ùå chat_list_view element not found!"),G(),s&&(s.style.display=e.length===0?"flex":"none");const l=t.querySelectorAll(".chat-item"),a=l.length;if(a>0&&a===e.length){console.log("üìã Updating unread counts for existing chat items"),K(e);return}if(l.forEach(i=>i.remove()),a>0&&console.log(`üóëÔ∏è Removed ${a} existing chat item(s) from DOM`),e.length===0){console.log("üìã No chats to display, showing empty state");return}console.log("üìã Rendering",e.length,"chats");const r=[...e].sort((i,n)=>{const p=i.last_message?new Date(i.last_message.created_at).getTime():i.updated_at?new Date(i.updated_at).getTime():0;return(n.last_message?new Date(n.last_message.created_at).getTime():n.updated_at?new Date(n.updated_at).getTime():0)-p});console.log("üìã Sorted chats:",r.map(i=>({id:i.id,latest:i.last_message?.created_at||i.updated_at||"none"}))),r.forEach((i,n)=>{const p=document.createElement("div");p.className=`chat-item p-3 border-b border-border cursor-pointer hover:bg-muted/50 ${i.id===m?"bg-muted/30":""}`,p.setAttribute("data-chat-id",i.id),p.onclick=()=>selectChat(i.id);const y=i.candidate&&i.candidate.name?i.candidate.name:"Onbekend",u=i.last_message?i.last_message.message:"",h=i.last_message&&i.last_message.time?i.last_message.time:"",A=i.candidate&&i.candidate.avatar?i.candidate.avatar:null,d=i.unread_count!==void 0&&i.unread_count!==null?parseInt(i.unread_count):0;console.log("üî¥ Backend Chat",i.id,"candidate:",y,"unread_count:",d,"chat.unread_count:",i.unread_count,"chat keys:",Object.keys(i)),d>0?console.log("‚úÖ Will add badge for chat",i.id,"with count:",d):console.log("‚ùå No badge for chat",i.id,"unread_count is:",d),p.innerHTML=`
            <div class="flex items-center gap-3">
                <div class="bg-accent/60 flex size-11 shrink-0 items-center justify-center rounded-full border border-border relative" style="position: relative; overflow: visible;">
                    ${A?`<img src="${x(A)}" alt="${x(y)}" class="w-full h-full rounded-full object-cover" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; border-radius: 50%;" onerror="this.parentElement.innerHTML='<span class=\\'text-primary font-semibold text-sm\\' style=\\'position: relative; z-index: 1;\\'>${y.charAt(0).toUpperCase()}</span>'">`:`<span class="text-primary font-semibold text-sm" style="position: relative; z-index: 1;">${y.charAt(0).toUpperCase()}</span>`}
                    ${d>0?`
                        <span class="absolute top-0 end-0 flex items-center justify-center w-[18px] h-[18px] rounded-full bg-red-500 text-white text-[10px] font-semibold leading-none z-10" style="box-sizing: border-box; background-color: rgb(239, 68, 68) !important; color: white !important; display: flex !important; visibility: visible !important; opacity: 1 !important; position: absolute !important; top: -2px !important; right: -2px !important; z-index: 10 !important; width: 18px !important; height: 18px !important; border-radius: 50% !important; transform: none !important;">
                            ${d>9?"9+":d}
                        </span>
                    `:""}
                </div>
                <div class="flex-1 min-w-0">
                    <div class="font-semibold text-sm">${x(y)}</div>
                    ${u?`<div class="text-xs text-muted-foreground truncate">${x(u)}</div>`:'<div class="text-xs text-muted-foreground">Geen berichten</div>'}
                </div>
                <div class="flex flex-col items-end gap-1 shrink-0">
                    ${h?`<div class="text-xs text-muted-foreground">${h}</div>`:""}
                </div>
            </div>
        `,t.appendChild(p),console.log(`‚úÖ Added chat item ${n+1} for chat ${i.id} (${y})`)});const c=t.querySelectorAll(".chat-item");console.log("‚úÖ Chat list rendered with",e.length,"items. DOM contains",c.length,"items"),console.log("üìã Chat list container after render:",{children:t.children.length,innerHTML:t.innerHTML.substring(0,200)+"..."})}function G(){fetch("/admin/chat/candidates",{headers:{"X-CSRF-TOKEN":M()}}).then(e=>e.json()).then(e=>{const t=document.getElementById("chat_candidate_select");t&&e.length>0&&(t.innerHTML='<option value="">Selecteer een kandidaat...</option>'+e.map(s=>`<option value="${s.id}" data-match-id="${s.match_id||""}">${s.name}${s.vacancy_title?" - "+s.vacancy_title:""}</option>`).join(""))}).catch(e=>{console.error("Error loading candidates:",e)})}window.handleCandidateSelect=function(){const e=document.getElementById("chat_candidate_select");if(!e||!e.value)return;const t=e.options[e.selectedIndex],s=e.value,o=t.getAttribute("data-match-id");s&&(openChatWithCandidate(s,o||null,o?"match":"application"),e.value="")};window.selectChat=function(e){if(!e){console.error("‚ùå selectChat called without chatId");return}console.log("üîµ selectChat called with chatId:",e),m=e;let t=f.find(a=>a.id===e);console.log("üîµ Found chat in activeChats:",t?"Yes":"No");const s=document.getElementById("chat_drawer"),o=document.getElementById("chat_drawer_backdrop");if(s){console.log("üîµ Setting drawer attributes..."),P=!1,s.removeAttribute("data-drawer-closed"),s.classList.remove("hidden"),w=!0;try{s.style.setProperty("display","flex","important"),s.style.setProperty("visibility","visible","important"),s.style.setProperty("opacity","1","important"),s.style.setProperty("z-index","99999","important"),s.style.setProperty("transform","translateX(0)","important"),s.style.setProperty("right","1.25rem","important"),s.style.setProperty("left","unset","important"),s.setAttribute("data-chat-active","true"),s.setAttribute("data-ignore-observer","true");const a=()=>{w=!0;try{s.style.setProperty("transform","translateX(0)","important"),s.style.setProperty("right","1.25rem","important"),s.style.setProperty("left","unset","important"),s.style.setProperty("display","flex","important"),s.style.setProperty("transition","none","important"),s.style.setProperty("animation","none","important")}finally{setTimeout(()=>{w=!1},10)}};a(),requestAnimationFrame(()=>{a(),requestAnimationFrame(()=>{a()})}),setTimeout(a,10),setTimeout(a,50),setTimeout(a,100)}finally{setTimeout(()=>{w=!1},150)}console.log("üîµ Drawer should be visible now, computed display:",window.getComputedStyle(s).display)}else console.error("‚ùå Drawer element not found in selectChat!");if(o&&(o.classList.remove("hidden"),o.style.setProperty("display","block","important"),o.style.setProperty("visibility","visible","important"),o.style.setProperty("z-index","99998","important")),!t)if(v&&v.id===e)t=v,f.findIndex(r=>r.id===e)===-1&&f.unshift(t);else{loadActiveChats().then(()=>{t=f.find(a=>a.id===e),t?(v=t,j(t),H(e),F()):(j({id:e,candidate:{name:"Loading..."}}),H(e),F())});return}v=t;const l=document.getElementById("chat_messages");l&&(console.log("üßπ Clearing messages container before switching to chat:",e),l.innerHTML=""),j(t),H(e),F()};function j(e){console.log("üü¢ updateChatViews called with chat:",e);const t=document.getElementById("chat_list_view"),s=document.getElementById("chat_messages_view"),o=document.getElementById("chat_header_name"),l=document.getElementById("chat_header_avatar"),a=document.getElementById("chat_user_avatar"),r=document.getElementById("chat_drawer"),c=document.getElementById("chat_drawer_backdrop");if(r){P=!1,r.removeAttribute("data-drawer-closed"),r.classList.remove("hidden"),w=!0;try{r.style.setProperty("display","flex","important"),r.style.setProperty("visibility","visible","important"),r.style.setProperty("opacity","1","important"),r.style.setProperty("z-index","99999","important"),r.style.setProperty("transform","translateX(0)","important"),r.style.setProperty("right","1.25rem","important"),r.style.setProperty("left","unset","important"),r.style.setProperty("transition","none","important"),r.style.setProperty("animation","none","important"),r.setAttribute("data-chat-active","true")}finally{setTimeout(()=>{w=!1},10)}console.log("üü¢ Drawer made visible in updateChatViews, computed display:",window.getComputedStyle(r).display)}if(c&&(c.classList.remove("hidden"),c.style.setProperty("display","block","important"),c.style.setProperty("visibility","visible","important"),c.style.setProperty("z-index","99998","important")),t?(t.style.setProperty("display","none","important"),t.style.setProperty("visibility","hidden","important"),t.style.setProperty("opacity","0","important"),console.log("üü¢ Chat list view hidden")):console.error("‚ùå chat_list_view element not found!"),s?(s.style.setProperty("display","flex","important"),s.style.setProperty("visibility","visible","important"),s.style.setProperty("opacity","1","important"),s.classList.remove("hidden"),console.log("üü¢ Chat messages view shown")):console.error("‚ùå chat_messages_view element not found!"),e){if(o&&e.candidate&&(o.textContent=e.candidate.name),l&&e.candidate){const i=l.parentElement;if(e.candidate.avatar&&!e.candidate.avatar.includes("/assets/media/avatars/300-5.png"))if(i&&(i.style.overflow="hidden"),l.tagName==="SPAN"){const n=document.createElement("img");n.src=e.candidate.avatar,n.alt=e.candidate.name,n.className="w-full h-full rounded-full object-cover",n.style.cssText="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; border-radius: 50%; object-fit: cover;",n.onerror=function(){this.remove(),l.textContent=e.candidate.name.charAt(0).toUpperCase(),l.style.display="block"},l.style.display="none",i.appendChild(n)}else l.tagName==="IMG"&&(l.src=e.candidate.avatar,l.style.cssText="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; border-radius: 50%; object-fit: cover;",l.onerror=function(){const n=this.parentElement;n.innerHTML=`<span class="text-primary font-semibold text-sm" id="chat_header_avatar" style="position: relative; z-index: 1;">${e.candidate.name.charAt(0).toUpperCase()}</span>`});else if(l.tagName==="SPAN")l.textContent=e.candidate.name.charAt(0).toUpperCase(),l.style.display="block";else{const n=l.parentElement;n.innerHTML=`<span class="text-primary font-semibold text-sm" id="chat_header_avatar" style="position: relative; z-index: 1;">${e.candidate.name.charAt(0).toUpperCase()}</span>`}}a&&e.user&&e.user.avatar&&(a.src=e.user.avatar)}setTimeout(()=>{U(),Y();const i=document.getElementById("chat_message_input");i&&i.focus()},100)}function Y(){const e=document.querySelector("#chat_messages_view .kt-scrollable-y-auto");e&&(e.removeEventListener("scroll",X),e.addEventListener("scroll",X),R())}function X(){if(z)return;const e=document.querySelector("#chat_messages_view .kt-scrollable-y-auto");if(!e)return;e.scrollHeight-e.scrollTop<=e.clientHeight+50?$=!1:$=!0,R()}window.showChatList=function(){console.log("üìã showChatList called");const e=document.getElementById("chat_list_view"),t=document.getElementById("chat_messages_view");m=null,v=null,N&&clearInterval(N),q&&clearInterval(q),t&&(t.style.display="none",t.style.visibility="hidden"),e&&(e.style.display="flex",e.style.visibility="visible",e.style.opacity="1"),loadActiveChats().then(()=>{B(f)})};function U(){const e=document.getElementById("chat_message_input");if(!e){console.warn("‚ö†Ô∏è Chat input not found, will retry...");return}const t=e.cloneNode(!0);e.parentNode.replaceChild(t,e);const s=function(){t.style.height="auto",t.style.height=Math.min(t.scrollHeight,200)+"px"};t.addEventListener("keypress",function(l){l.key==="Enter"&&!l.shiftKey?(l.preventDefault(),console.log("‚å®Ô∏è Enter key pressed, calling sendMessage"),window.sendMessage?window.sendMessage():console.error("‚ùå sendMessage function not found!")):onChatMessageInput&&onChatMessageInput()}),t.addEventListener("input",function(){s(),onChatMessageInput&&onChatMessageInput()}),s(),setTimeout(()=>{t.focus()},50);const o=document.getElementById("chat_send_button");o&&!o.hasAttribute("data-send-listener-added")?(o.setAttribute("data-send-listener-added","true"),o.addEventListener("click",function(l){l.preventDefault(),l.stopPropagation(),console.log("üîµ Send button clicked via event listener"),window.sendMessage?window.sendMessage():console.error("‚ùå sendMessage function not found!")}),console.log("‚úÖ Send button event listener added")):o||console.warn("‚ö†Ô∏è Send button not found!"),console.log("‚úÖ Chat input event listeners initialized")}function H(e){if(console.log("üì• Loading messages for chat:",e),m!==e){const t=document.getElementById("chat_messages");t&&(console.log("üßπ Clearing messages container for new chat"),t.innerHTML="")}return fetch(`/admin/chat/${e}/messages`,{headers:{"X-CSRF-TOKEN":M()}}).then(t=>{if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return t.json()}).then(t=>{if(console.log("‚úÖ Messages loaded:",t),Array.isArray(t))if(m===e){J(t,e),setTimeout(()=>{E()},100);const s=f.findIndex(o=>o.id===e);s!==-1&&(f[s].unread_count=0,K([f[s]]))}else console.log("‚è≠Ô∏è Skipping render - chat changed from",e,"to",m);else console.error("‚ùå Messages is not an array:",t);return t}).catch(t=>{throw console.error("‚ùå Error loading messages:",t),t})}function I(){const e=document.getElementById("chat_messages");if(!e)return;const t=Array.from(e.querySelectorAll(".flex.items-end"));if(t.length===0)return;const s=t.map(o=>{const l=o.getAttribute("data-timestamp");let a=null;if(l)a=new Date(l);else{const r=o.querySelector(".text-xs.font-medium");if(r){const c=r.textContent.trim(),i=new Date,[n,p]=c.split(":").map(Number);!isNaN(n)&&!isNaN(p)&&(a=new Date(i.getFullYear(),i.getMonth(),i.getDate(),n,p))}a||(a=new Date)}return{element:o,timestamp:a}});s.sort((o,l)=>o.timestamp.getTime()-l.timestamp.getTime()),s.forEach(({element:o})=>{e.appendChild(o)})}function J(e,t=null){console.log("üé® Rendering messages:",e,"for chat:",t||m);const s=document.getElementById("chat_messages");if(!s){console.error("‚ùå Messages container not found!");return}if(t!==null&&t!==m){console.log("‚è≠Ô∏è Skipping render - chat mismatch. Expected:",t,"Current:",m);return}const o=s.querySelectorAll('[data-optimistic="false"]');console.log("üßπ Removing",o.length,"existing real messages"),o.forEach(d=>d.remove());const l=Array.from(s.querySelectorAll('[data-optimistic="true"]')),a=l.map(d=>{const b=d.getAttribute("data-message-text")||d.querySelector(".kt-card p")?.textContent||"",g=d.getAttribute("data-optimistic-id"),k=d.getAttribute("data-timestamp"),_=d.getAttribute("data-chat-id");return _&&_!==String(m)?(console.log("üóëÔ∏è Removing optimistic message from different chat:",_,"current:",m),d.remove(),null):{element:d,text:b,id:g,timestamp:k?new Date(k):new Date}}).filter(d=>d!==null),r=Array.isArray(e)&&e.length>0,c=l.length>0,i=r||c;let n=s.querySelector(".chat-empty-message");if(i?n&&n.remove():n||(n=document.createElement("div"),n.className="chat-empty-message text-center text-muted-foreground p-4",n.textContent="Geen berichten",s.appendChild(n)),!r)return void 0;const p=new Set,y=new Map;Array.from(s.querySelectorAll(".flex.items-end")).forEach(d=>{if(!(d.getAttribute("data-optimistic")==="true")){const g=d.getAttribute("data-message-id");g&&(p.add(g),y.set(g,d))}}),new Set(a.map(({text:d})=>d));const h=e.filter(d=>!(d.id&&p.has(String(d.id))));if(h.length===0){console.log("‚úÖ No new messages to render, all messages already exist or are optimistic"),a.forEach(({element:k,text:_,timestamp:L})=>{if(!_||!L)return;const T=e.filter(S=>S.message===_);if(T.length===0)return;let C=null,O=1/0;if(T.forEach(S=>{if(S.created_at){const W=new Date(S.created_at),V=Math.abs(W.getTime()-L.getTime());V<O&&(O=V,C=S)}}),C&&O<5e3){const S=s.querySelector(`[data-optimistic="false"][data-message-id="${C.id}"]`);S&&S.offsetParent!==null?(console.log("üîÑ Removing optimistic message, matching real message exists in DOM:",_,"ID:",C.id),k.remove(),I()):console.log("‚è≥ Keeping optimistic message, real message not yet in DOM or visible:",_)}}),I();const b=s.querySelectorAll(".flex.items-end").length>0;let g=s.querySelector(".chat-empty-message");b?g&&g.remove():g||(g=document.createElement("div"),g.className="chat-empty-message text-center text-muted-foreground p-4",g.textContent="Geen berichten",s.appendChild(g)),E();return}const A=h.map(d=>{const b=d.is_own;if(d.sender_name&&d.sender_name.charAt(0).toUpperCase(),b){const g=v&&v.user&&v.user.avatar?v.user.avatar:"/assets/media/avatars/300-2.png",k=d.created_at?new Date(d.created_at).toISOString():new Date().toISOString();return`
                <div class="flex items-end justify-end gap-3.5 px-5" data-optimistic="false" data-message-id="${d.id||""}" data-message-text="${x(d.message)}" data-timestamp="${k}" data-chat-id="${m||""}">
                    <div class="flex flex-col gap-1.5">
                        <div class="kt-card bg-primary rounded-be-none flex flex-col gap-2.5 p-3 shadow-none">
                            <p class="text-2sm text-primary-foreground font-medium">${x(d.message)}</p>
                        </div>
                        <div class="relative flex items-center justify-end gap-2">
                            <span class="text-xs font-medium text-secondary-foreground">${d.time}</span>
                            ${d.is_read!==void 0?`<i class="ki-filled ki-double-check text-lg ${d.is_read?"text-green-500":"text-gray-400"}"></i>`:""}
                        </div>
                    </div>
                    <div class="relative shrink-0">
                        <div class="kt-avatar size-9">
                            <div class="kt-avatar-image">
                                <img alt="${d.sender_name}" class="size-9 rounded-full object-cover" src="${g}" />
                            </div>
                            <div class="kt-avatar-indicator -bottom-2 -end-2">
                                <div class="kt-avatar-status kt-avatar-status-online size-2.5"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `}else{const g=d.sender_avatar||"/assets/media/avatars/300-5.png",k=d.user&&d.user.is_online!==void 0?d.user.is_online:!1,_=d.created_at?new Date(d.created_at).toISOString():new Date().toISOString();return`
                <div class="flex items-end gap-3.5 px-5" data-optimistic="false" data-message-id="${d.id||""}" data-message-text="${x(d.message)}" data-timestamp="${_}" data-chat-id="${m||""}">
                    <div class="relative shrink-0">
                        <div class="kt-avatar size-9">
                            <div class="kt-avatar-image">
                                <img alt="${x(d.sender_name)}" class="size-9 rounded-full object-cover" src="${x(g)}" onerror="this.src='/assets/media/avatars/300-5.png'" />
                            </div>
                            <div class="kt-avatar-indicator -bottom-2 -end-2">
                                <div class="kt-avatar-status ${k?"kt-avatar-status-online":"kt-avatar-status-offline"}"></div>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col gap-1.5">
                        <div class="kt-card bg-accent/60 rounded-bs-none text-2sm flex flex-col gap-2.5 p-3 shadow-none relative">
                            ${x(d.message)}
                        </div>
                        <div class="relative flex items-center gap-2">
                            <span class="text-xs font-medium text-muted-foreground">${d.time}</span>
                            ${d.is_read!==void 0?`<i class="ki-filled ki-double-check text-lg ${d.is_read?"text-green-500":"text-gray-400"}"></i>`:""}
                        </div>
                    </div>
                </div>
            `}}).join("");A&&s.insertAdjacentHTML("beforeend",A),I(),E(),a.forEach(({element:d,text:b,timestamp:g,id:k})=>{if(!d||!d.parentNode||!b||!g)return;const _=e.filter(C=>C.message===b);if(_.length===0){console.log("‚è≥ Keeping optimistic message, no matching message in response yet:",b);return}let L=null,T=1/0;_.forEach(C=>{if(C.created_at){const O=new Date(C.created_at),S=Math.abs(O.getTime()-g.getTime());S<T&&(T=S,L=C)}}),L&&T<5e3?setTimeout(()=>{if(d&&d.parentNode){const C=s.querySelector(`[data-optimistic="false"][data-message-id="${L.id}"]`);C&&C.offsetParent!==null?(console.log("üîÑ Removing optimistic message, matching real message exists in DOM:",b,"ID:",L.id,"timeDiff:",T),d.remove(),I(),E()):console.log("‚è≥ Keeping optimistic message, real message not yet visible:",b)}},150):console.log("‚è≥ Keeping optimistic message, no close timestamp match found:",b,"closestTimeDiff:",T)}),console.log("‚úÖ Messages rendered, count:",e.length,"new messages:",h.length,"optimistic preserved:",a.length,"container:",s),requestAnimationFrame(()=>{const b=s.querySelectorAll(".flex.items-end").length>0;let g=s.querySelector(".chat-empty-message");b?g&&g.remove():g||(g=document.createElement("div"),g.className="chat-empty-message text-center text-muted-foreground p-4",g.textContent="Geen berichten",s.appendChild(g))})}function Q(e,t=!1){const s=document.getElementById("chat_messages");if(!s)return console.error("‚ùå Messages container not found!"),null;const o=s.querySelector(".chat-empty-message");o&&o.remove();const l=v&&v.user&&v.user.avatar?v.user.avatar:"/assets/media/avatars/300-2.png",a=new Date,r=a.toLocaleTimeString("nl-NL",{hour:"2-digit",minute:"2-digit"}),c=a.toISOString(),i=t?`optimistic-${Date.now()}-${Math.random().toString(36).substr(2,9)}`:null,n=document.createElement("div");return n.className="flex items-end justify-end gap-3.5 px-5",n.setAttribute("data-optimistic",t?"true":"false"),n.setAttribute("data-message-text",x(e)),n.setAttribute("data-timestamp",c),n.setAttribute("data-chat-id",String(m||"")),i&&n.setAttribute("data-optimistic-id",i),n.innerHTML=`
        <div class="flex flex-col gap-1.5">
            <div class="kt-card bg-primary rounded-be-none flex flex-col gap-2.5 p-3 shadow-none">
                <p class="text-2sm text-primary-foreground font-medium">${x(e)}</p>
            </div>
            <div class="relative flex items-center justify-end gap-2">
                <span class="text-xs font-medium text-secondary-foreground">${r}</span>
                ${t?'<i class="ki-filled ki-time text-lg text-gray-400"></i>':""}
            </div>
        </div>
        <div class="relative shrink-0">
            <div class="kt-avatar size-9">
                <div class="kt-avatar-image">
                    <img alt="You" class="size-9 rounded-full object-cover" src="${l}" />
                </div>
                <div class="kt-avatar-indicator -bottom-2 -end-2">
                    <div class="kt-avatar-status kt-avatar-status-online size-2.5"></div>
                </div>
            </div>
        </div>
    `,s.appendChild(n),I(),E(),n}window.sendMessage=function(){console.log("üîµ sendMessage called");const e=document.getElementById("chat_message_input");if(!e){console.error("‚ùå Chat input element not found!");return}if(!e.value||!e.value.trim()){console.warn("‚ö†Ô∏è Cannot send message: input is empty");return}if(!m){console.warn("‚ö†Ô∏è Cannot send message: no chat selected, currentChatId:",m);return}const t=e.value.trim();console.log("üì§ Sending message:",t,"to chat:",m);const s=Q(t,!0);e.value="",e.style&&(e.style.height="auto");const o=new FormData;o.append("message",t);const l=M();if(!l){console.error("‚ùå CSRF token not found!"),s&&s.remove(),e.value=t;return}fetch(`/admin/chat/${m}/message`,{method:"POST",headers:{"X-CSRF-TOKEN":l,Accept:"application/json"},body:o}).then(a=>(console.log("üì° Response status:",a.status),a.ok?a.json():a.text().then(r=>{throw console.error("‚ùå Response error:",r),new Error(`HTTP error! status: ${a.status}, body: ${r}`)}))).then(a=>{if(console.log("‚úÖ Message sent successfully:",a),a.success&&a.message){const r=document.getElementById("chat_messages");let c=!1;if(r)if(a.message.id?r.querySelector(`[data-optimistic="false"][data-message-id="${a.message.id}"]`):null)s&&s.remove();else{const n=v&&v.user&&v.user.avatar?v.user.avatar:"/assets/media/avatars/300-2.png",p=a.message.created_at?new Date(a.message.created_at).toISOString():new Date().toISOString(),y=`
                        <div class="flex items-end justify-end gap-3.5 px-5" data-optimistic="false" data-message-id="${a.message.id||""}" data-message-text="${x(a.message.message)}" data-timestamp="${p}" data-chat-id="${m||""}">
                            <div class="flex flex-col gap-1.5">
                                <div class="kt-card bg-primary rounded-be-none flex flex-col gap-2.5 p-3 shadow-none">
                                    <p class="text-2sm text-primary-foreground font-medium">${x(a.message.message)}</p>
                                </div>
                                <div class="relative flex items-center justify-end gap-2">
                                    <span class="text-xs font-medium text-secondary-foreground">${a.message.time}</span>
                                    ${a.message.is_read!==void 0?`<i class="ki-filled ki-double-check text-lg ${a.message.is_read?"text-green-500":"text-gray-400"}"></i>`:""}
                                </div>
                            </div>
                            <div class="relative shrink-0">
                                <div class="kt-avatar size-9">
                                    <div class="kt-avatar-image">
                                        <img alt="${a.message.sender_name}" class="size-9 rounded-full object-cover" src="${n}" />
                                    </div>
                                    <div class="kt-avatar-indicator -bottom-2 -end-2">
                                        <div class="kt-avatar-status kt-avatar-status-online size-2.5"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;r.insertAdjacentHTML("beforeend",y),c=!0,I(),E(),requestAnimationFrame(()=>{const u=r.querySelector(`[data-optimistic="false"][data-message-id="${a.message.id||""}"]`);u&&u.offsetParent!==null?s&&s.parentNode&&(console.log("üîÑ Removing optimistic message, real message confirmed in DOM"),s.remove(),I(),E()):(console.log("‚è≥ Keeping optimistic message, real message not yet visible"),setTimeout(()=>{const h=r.querySelector(`[data-optimistic="false"][data-message-id="${a.message.id||""}"]`);h&&h.offsetParent!==null&&s&&s.parentNode&&(s.remove(),I(),E())},50))}),E()}if(v&&a.message){v.last_message={message:a.message.message,created_at:a.message.created_at,time:a.message.time};const i=f.findIndex(n=>n.id===m);i!==-1&&(f[i].last_message=v.last_message,f[i].updated_at=a.message.created_at||new Date().toISOString())}c&&(setTimeout(()=>{H(m)},500),setTimeout(()=>{const i=document.getElementById("chat_list_view");i&&window.getComputedStyle(i).display!=="none"?(B(f),loadActiveChats(!1).then(()=>{B(f)})):loadActiveChats(!1)},600))}else console.error("‚ùå Message send failed:",a),s&&s.remove(),e.value=t}).catch(a=>{console.error("‚ùå Error sending message:",a),s&&s.remove(),e.value=t})};window.handleDrawerClose=function(){const e=document.getElementById("chat_drawer"),t=document.getElementById("chat_drawer_backdrop");if(!e)return;console.log("üîí handleDrawerClose called - closing drawer"),P=!0,m=null,v=null;const s=()=>{e&&(e.setAttribute("data-drawer-closed","true"),e.removeAttribute("style"),e.classList.add("hidden"),e.removeAttribute("data-chat-active"),e.style.cssText="display: none !important; visibility: hidden !important; opacity: 0 !important; transform: translateX(100%) !important; right: -100% !important; left: unset !important; z-index: -1 !important;",e.classList.remove("open"))},o=()=>{t&&(t.removeAttribute("style"),t.classList.add("hidden"),t.style.cssText="display: none !important; visibility: hidden !important; opacity: 0 !important; z-index: -1 !important;")};if(window.KTDrawer){const i=window.KTDrawer.getInstance(e);if(i)try{i.hide()}catch(n){console.log("‚ö†Ô∏è Error hiding drawer instance:",n)}}const l=document.querySelector('[data-kt-drawer-toggle="#chat_drawer"]');if(l&&(!e.classList.contains("hidden")||window.getComputedStyle(e).display!=="none"))try{l.click()}catch(n){console.log("‚ö†Ô∏è Error clicking toggle:",n)}s(),o(),[0,10,50,100,200,300,500,1e3].forEach(i=>{setTimeout(()=>{s(),o()},i)});let r=0;const c=setInterval(()=>{e&&P?(s(),o(),r++,r>=30&&clearInterval(c)):clearInterval(c)},100)};window.endChat=function(){m&&confirm("Weet je zeker dat je deze chat wilt be√´indigen?")&&fetch(`/admin/chat/${m}/end`,{method:"POST",headers:{"X-CSRF-TOKEN":M()}}).then(e=>e.json()).then(e=>{if(e.success){m=null,v=null;const t=document.getElementById("chat_drawer");t&&t.removeAttribute("data-chat-active"),loadActiveChats();const s=document.getElementById("chat_messages");s&&(s.innerHTML=""),showChatList()}}).catch(e=>{console.error("Error ending chat:",e)})};function F(e){q&&clearInterval(q),N&&clearInterval(N),q=setInterval(()=>{m&&H(m)},500),N=setInterval(()=>{m&&Z(m)},1e3)}function Z(e){fetch(`/admin/chat/${e}/typing`,{headers:{"X-CSRF-TOKEN":M()}}).then(t=>t.json()).then(t=>{const s=document.getElementById("chat_typing_indicator_header");if(s)if(t.length>0){const o=t.map(l=>l.name).join(", ");s.textContent=`${o} ${t.length===1?"is":"zijn"} aan het typen...`,s.style.display="block"}else s.style.display="none"}).catch(t=>{console.error("Error checking typing:",t)})}window.onChatMessageInput=function(){!document.getElementById("chat_message_input")||!m||fetch(`/admin/chat/${m}/typing`,{method:"POST",headers:{"X-CSRF-TOKEN":M()}})};function E(e=!1){if(!e&&$){R();return}requestAnimationFrame(()=>{const t=document.getElementById("chat_messages");if(t){const s=t.closest(".kt-scrollable-y-auto");s?(z=!0,s.scrollTop=s.scrollHeight,setTimeout(()=>{z=!1,$=!1,R()},100)):(z=!0,t.scrollTop=t.scrollHeight,setTimeout(()=>{z=!1,$=!1,R()},100))}})}function R(){const e=document.querySelector("#chat_messages_view .kt-scrollable-y-auto"),t=document.getElementById("scroll_to_bottom_btn");if(!e||!t)return;e.scrollHeight-e.scrollTop<=e.clientHeight+50?t.style.display="none":t.style.display="flex"}window.scrollToBottomManually=function(){$=!1,E(!0)};function x(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("chat_drawer"),t=document.getElementById("chat_drawer_backdrop");e&&(e.classList.add("hidden"),e.style.display="none",e.style.visibility="hidden",e.style.opacity="0"),t&&(t.classList.add("hidden"),t.style.display="none",t.style.visibility="hidden"),e&&(new MutationObserver(function(r){r.forEach(function(c){if(c.type==="attributes"&&c.attributeName==="class"){if(e&&e.getAttribute("data-ignore-observer")==="true"){console.log("‚è≠Ô∏è Observer skipped - ignore flag set");return}if(P||e&&e.getAttribute("data-drawer-closed")==="true"){console.log("‚è≠Ô∏è Observer skipped - drawer explicitly closed");return}const i=!e.classList.contains("hidden");if(console.log("üëÅÔ∏è Observer detected drawer state change, isOpen:",i,"currentChatId:",m),i){if(D){console.log("‚è≠Ô∏è Observer skipped - isOpeningChat flag set");return}if(w)return;w=!0;try{e.style.setProperty("display","flex","important"),e.style.setProperty("visibility","visible","important"),e.style.setProperty("opacity","1","important"),e.style.setProperty("z-index","99999","important"),e.style.setProperty("transform","translateX(0)","important"),e.style.setProperty("right","1.25rem","important"),e.style.setProperty("left","unset","important"),t.style.setProperty("display","block","important"),t.style.setProperty("visibility","visible","important"),t.style.setProperty("z-index","99998","important")}finally{setTimeout(()=>{w=!1},10)}t&&t.classList.remove("hidden");const n=document.getElementById("chat_list_view"),p=document.getElementById("chat_messages_view");m?(n&&(n.style.setProperty("display","none","important"),n.style.setProperty("visibility","hidden","important"),n.style.setProperty("opacity","0","important")),p&&(p.style.setProperty("display","flex","important"),p.style.setProperty("visibility","visible","important"),p.style.setProperty("opacity","1","important"),p.classList.remove("hidden"))):(n&&(n.style.setProperty("display","flex","important"),n.style.setProperty("visibility","visible","important"),n.style.setProperty("opacity","1","important")),p&&(p.style.setProperty("display","none","important"),p.style.setProperty("visibility","hidden","important"),p.style.setProperty("opacity","0","important"))),loadActiveChats().then(()=>{m||B(f)}),setTimeout(()=>{const y=document.getElementById("chat_candidate_select");y&&!y.hasAttribute("data-listener-attached")&&(y.addEventListener("change",handleCandidateSelect),y.setAttribute("data-listener-attached","true"))},100)}else if(m||D||e?.getAttribute("data-chat-active")==="true"){if(e&&(e.classList.remove("hidden"),!w)){w=!0;try{e.style.setProperty("display","flex","important"),e.style.setProperty("visibility","visible","important"),e.style.setProperty("opacity","1","important"),e.style.setProperty("z-index","99999","important"),e.style.setProperty("transform","translateX(0)","important"),e.style.setProperty("right","1.25rem","important"),e.style.setProperty("left","unset","important"),e.setAttribute("data-chat-active","true")}finally{setTimeout(()=>{w=!1},10)}}t&&(t.classList.remove("hidden"),t.style.display="block",t.style.visibility="visible")}else e&&(e.removeAttribute("data-chat-active"),e.style.display="none",e.style.visibility="hidden",e.style.opacity="0"),t&&(t.classList.add("hidden"),t.style.display="none",t.style.visibility="hidden")}})}).observe(e,{attributes:!0,attributeFilter:["class"]}),new MutationObserver(function(r){w||P||e&&e.getAttribute("data-drawer-closed")==="true"||e&&e.getAttribute("data-chat-active")==="true"&&requestAnimationFrame(()=>{if(w)return;const c=window.getComputedStyle(e).transform,i=window.getComputedStyle(e).right,n=window.getComputedStyle(e).left,p=c!=="none"&&c!=="matrix(1, 0, 0, 1, 0, 0)",y=i!=="1.25rem"&&i!=="20px",u=n!=="auto"&&n!=="unset";if(p||y||u){w=!0;try{if(p&&(console.log("üîÑ Style observer: Resetting transform from",c),e.style.setProperty("transform","translateX(0)","important")),y&&(console.log("üîÑ Style observer: Resetting right from",i),e.style.setProperty("right","1.25rem","important")),u){console.log("üîÑ Style observer: Resetting left from",n),e.style.left&&e.style.removeProperty("left");const h=e.getAttribute("style");if(h){const A=h.replace(/left\s*:\s*[^;!]+(!important)?;?/gi,"").trim();A!==h&&e.setAttribute("style",A)}e.style.setProperty("left","unset","important")}}finally{setTimeout(()=>{w=!1},50)}}})}).observe(e,{attributes:!0,attributeFilter:["style","class"],attributeOldValue:!1,childList:!1,subtree:!1}),setInterval(function(){if(w)return;if(P||e&&e.getAttribute("data-drawer-closed")==="true"){e&&(e.setAttribute("data-drawer-closed","true"),e.classList.add("hidden"),e.removeAttribute("data-chat-active"),e.style.setProperty("display","none","important"),e.style.setProperty("visibility","hidden","important"),e.style.setProperty("opacity","0","important"),e.style.setProperty("transform","translateX(100%)","important"),e.style.setProperty("right","-100%","important"),e.style.setProperty("z-index","-1","important"),e.classList.remove("open")),t&&(t.classList.add("hidden"),t.style.setProperty("display","none","important"),t.style.setProperty("visibility","hidden","important"),t.style.setProperty("opacity","0","important"),t.style.setProperty("z-index","-1","important"));return}const r=m||D||e&&e.getAttribute("data-chat-active")==="true";if(r&&e){const c=e.classList.contains("hidden"),i=window.getComputedStyle(e).display;(c||i==="none")&&(console.log("üîÑ Interval: Drawer was hidden, reopening...",{isMarkedHidden:c,computedDisplay:i}),e.classList.remove("hidden")),w=!0;try{e.style.setProperty("display","flex","important"),e.style.setProperty("visibility","visible","important"),e.style.setProperty("opacity","1","important"),e.style.setProperty("z-index","99999","important"),e.style.setProperty("transform","translateX(0)","important"),e.style.setProperty("right","1.25rem","important"),e.setAttribute("data-chat-active","true"),e.style.left&&e.style.removeProperty("left");const u=e.getAttribute("style");if(u){const h=u.replace(/left\s*:\s*[^;!]+(!important)?;?/gi,"").trim();h!==u&&e.setAttribute("style",h)}e.style.setProperty("left","unset","important"),e.style.setProperty("transition","none","important"),e.style.setProperty("animation","none","important")}finally{setTimeout(()=>{w=!1},10)}const n=window.getComputedStyle(e).transform,p=window.getComputedStyle(e).right,y=window.getComputedStyle(e).left;if(n!=="none"&&n!=="matrix(1, 0, 0, 1, 0, 0)"&&e.style.setProperty("transform","translateX(0)","important"),p!=="1.25rem"&&p!=="20px"&&e.style.setProperty("right","1.25rem","important"),y!=="unset"&&y!=="auto"){e.style.left&&e.style.removeProperty("left");const u=e.getAttribute("style");if(u){const h=u.replace(/left\s*:\s*[^;!]+(!important)?;?/gi,"").trim();h!==u&&e.setAttribute("style",h)}e.style.setProperty("left","unset","important")}t&&(t.classList.remove("hidden"),t.style.setProperty("display","block","important"),t.style.setProperty("visibility","visible","important"),t.style.setProperty("z-index","99998","important"))}else!r&&e&&e.getAttribute("data-chat-active")==="true"&&(console.log("üîÑ Interval: No active chat, removing active flag"),e.removeAttribute("data-chat-active"))},10)),t&&t.addEventListener("click",function(){window.handleDrawerClose&&window.handleDrawerClose()});const s=document.querySelector('[data-kt-drawer-toggle="#chat_drawer"]');s&&s.addEventListener("click",function(l){e&&(e.classList.contains("hidden")||window.getComputedStyle(e).display==="none")?(P=!1,e&&e.removeAttribute("data-drawer-closed"),console.log("üîì Toggle button clicked - resetting close flag to allow drawer to open")):(P=!0,e&&e.setAttribute("data-drawer-closed","true"),console.log("üîí Toggle button clicked - setting close flag")),setTimeout(()=>{e&&(e.classList.contains("hidden")||window.getComputedStyle(e).display==="none")?(P=!0,e&&e.setAttribute("data-drawer-closed","true")):(P=!1,e&&e.removeAttribute("data-drawer-closed"))},50);const r=()=>{e&&(e.classList.remove("hidden"),e.style.setProperty("display","flex","important"),e.style.setProperty("visibility","visible","important"),e.style.setProperty("opacity","1","important"),e.style.setProperty("z-index","99999","important"),e.style.setProperty("transform","translateX(0)","important"),e.style.setProperty("right","1.25rem","important"),e.style.setProperty("left","unset","important"),e.style.setProperty("transition","none","important"),e.style.setProperty("animation","none","important")),t&&(t.classList.remove("hidden"),t.style.setProperty("display","block","important"),t.style.setProperty("visibility","visible","important"),t.style.setProperty("z-index","99998","important"))};r(),requestAnimationFrame(()=>{r(),requestAnimationFrame(()=>{r()})}),setTimeout(r,10),setTimeout(r,50),setTimeout(r,100),setTimeout(r,200)}),e&&e.querySelectorAll('[data-kt-drawer-dismiss="true"]').forEach(a=>{a.addEventListener("click",function(r){r.preventDefault(),r.stopPropagation(),window.handleDrawerClose&&window.handleDrawerClose()})});const o=document.getElementById("chat_candidate_select");o&&o.addEventListener("change",handleCandidateSelect),setTimeout(()=>{U()},500),setInterval(()=>{if(!m){const l=document.getElementById("chat_list_view");l&&window.getComputedStyle(l).display!=="none"&&window.getComputedStyle(l).visibility!=="hidden"&&loadActiveChats(!1)}},1e4),document.addEventListener("keydown",function(l){if(l.key==="Escape"||l.keyCode===27){const a=document.getElementById("chat_drawer");if(a&&window.getComputedStyle(a).display!=="none"&&!a.classList.contains("hidden"))if(l.preventDefault(),l.stopPropagation(),l.stopImmediatePropagation(),console.log("‚å®Ô∏è ESC key pressed - closing drawer"),window.handleDrawerClose)window.handleDrawerClose();else{a.classList.add("hidden"),a.style.cssText="display: none !important; visibility: hidden !important; opacity: 0 !important;";const i=document.getElementById("chat_drawer_backdrop");i&&(i.classList.add("hidden"),i.style.cssText="display: none !important; visibility: hidden !important; opacity: 0 !important;")}}},!0),document.addEventListener("click",function(l){const a=document.getElementById("chat_drawer"),r=document.getElementById("chat_drawer_backdrop");if(!a||P||a.getAttribute("data-drawer-closed")==="true"||!(window.getComputedStyle(a).display!=="none"&&!a.classList.contains("hidden")))return;const n=l.target,p=a.contains(n);r&&(r===n||r.contains(n));const y=n.closest('[data-kt-drawer-toggle="#chat_drawer"]');!p&&!y&&(console.log("üñ±Ô∏è Click outside drawer - closing drawer"),window.handleDrawerClose&&window.handleDrawerClose())})});
