import"./frontend-app-B6vhmd6y.js";const Q=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1";Q&&console.log("üì¶ chat.js loaded!");let f=[],u=null,F=null,V=null,X=null,b=null,$=!1,x=!1,A=!1,O=!1,N=!1,B=!1;window.openChatWithCandidate=function(e,s,t){if(console.log("üöÄ openChatWithCandidate called!",{candidateId:e,matchOrAppId:s,type:t}),!e){console.error("‚ùå No candidateId provided!");return}A=!1;const n=document.getElementById("chat_drawer"),o=document.getElementById("chat_drawer_backdrop");n&&n.removeAttribute("data-drawer-closed");const r=document.querySelector('[data-kt-drawer-toggle="#chat_drawer"]');if(r)r.click();else if(n){const i=window.KTDrawer?.getInstance?.(n);i?i.show():n.classList.remove("hidden")}const a=new FormData;a.append("candidate_id",e),s&&s!=="null"&&s!==null&&t&&t!=="null"&&t!==""&&(t==="match"?a.append("match_id",s):t==="application"&&a.append("application_id",s)),$=!0;const d=document.getElementById("chat_list_view"),c=document.getElementById("chat_messages_view");d&&(d.style.setProperty("display","none","important"),d.style.setProperty("visibility","hidden","important"),d.style.setProperty("opacity","0","important")),c&&(c.style.setProperty("display","flex","important"),c.style.setProperty("visibility","visible","important"),c.style.setProperty("opacity","1","important"),c.classList.remove("hidden")),setTimeout(()=>{fetch("/admin/chat/start",{method:"POST",headers:{"X-CSRF-TOKEN":L()},body:a}).then(i=>i.json()).then(i=>{if(i.success){if(console.log("‚úÖ Chat started successfully:",i.chat_id),$=!0,u=i.chat_id,i.chat){const l=f.findIndex(p=>p.id===i.chat.id);l===-1?f.unshift(i.chat):f[l]=i.chat,b=i.chat,console.log("‚úÖ Chat added to activeChats:",i.chat)}if(n){n.setAttribute("data-chat-active","true"),n.setAttribute("data-ignore-observer","true"),window.chatDrawerObserver&&window.chatDrawerObserver.disconnect();const l=()=>{x=!0;try{n.style.setProperty("transform","translateX(0)","important"),n.style.setProperty("translate","0 0","important"),n.style.setProperty("right","1.25rem","important"),n.style.setProperty("left","auto","important"),n.style.setProperty("--tw-translate-x","0","important"),n.style.setProperty("inset-inline-start","auto","important"),n.style.setProperty("display","flex","important"),n.style.setProperty("transition","none","important"),n.style.setProperty("animation","none","important"),n.style.left&&n.style.removeProperty("left");const p=n.getAttribute("style");if(p){const v=p.replace(/left\s*:\s*[^;!]+(!important)?;?/gi,"").trim();v!==p&&n.setAttribute("style",v)}n.style.setProperty("left","auto","important")}finally{setTimeout(()=>{x=!1},10)}};l(),requestAnimationFrame(()=>{l(),requestAnimationFrame(()=>{l()})}),setTimeout(l,10),setTimeout(l,50),setTimeout(l,100),setTimeout(l,200),setTimeout(l,300)}o&&o.classList.remove("hidden");const y=document.getElementById("chat_list_view"),g=document.getElementById("chat_messages_view");if(y&&(y.style.setProperty("display","none","important"),y.style.setProperty("visibility","hidden","important"),y.style.setProperty("opacity","0","important")),g&&(g.style.setProperty("display","flex","important"),g.style.setProperty("visibility","visible","important"),g.style.setProperty("opacity","1","important"),g.classList.remove("hidden")),console.log("‚úÖ Selecting chat:",i.chat_id),selectChat(i.chat_id),setTimeout(()=>{n&&(n.removeAttribute("data-ignore-observer"),console.log("‚úÖ Removed ignore-observer flag"),window.chatDrawerObserver&&n&&window.chatDrawerObserver.observe(n,{attributes:!0,attributeFilter:["class"]}))},2e3),i.chat){const l=f.findIndex(p=>p.id===i.chat.id);l===-1?f.unshift(i.chat):f[l]=i.chat,u===i.chat.id&&(b=i.chat)}setTimeout(()=>{B||loadActiveChats(!1).then(()=>{const l=document.getElementById("chat_list_view");l&&!u&&window.getComputedStyle(l).display!=="none"&&z(f)})},600),setTimeout(()=>{$=!1},3e3)}}).catch(i=>{console.error("Error starting chat:",i),$=!1})},100)};function L(){return document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||""}window.loadActiveChats=function(e=!1,s=!1){return B?(console.log("‚è≠Ô∏è loadActiveChats already in progress, skipping..."),Promise.resolve(f)):(B=!0,console.log("üìã loadActiveChats called, showListView:",e),fetch("/admin/chat/active",{headers:{"X-CSRF-TOKEN":L()},cache:"no-cache"}).then(t=>{if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return t.json()}).then(t=>{if(console.log("‚úÖ Active chats loaded from server:",t),console.log("üìä Server returned",t.length,"chats"),!Array.isArray(t))return console.error("‚ùå Server response is not an array:",t),f;if(t.error)return console.error("‚ùå Server returned error:",t.error),f;const n=t.map(i=>i.id),o=f.map(i=>i.id);console.log("üìä Previous chats:",o),console.log("üìä Server chats:",n),t.forEach(i=>{const y=f.find(g=>g.id===i.id);if(y&&y.unread_count!==void 0){const g=i.unread_count||0,l=y.unread_count||0;i.unread_count=Math.max(g,l),l>g&&console.log("üìå Preserved unread count for chat",i.id,":",l,"(server had:",g,")")}});const r=f.find(i=>i.id===u);u&&r&&!n.includes(u)&&(t.push(r),console.log("üìå Preserved current chat that is not in server response"));const a=f.length;f=[...t],console.log(`üîÑ Replaced ${a} chats with ${f.length} chats from server`),console.log("üìã New activeChats array:",f.map(i=>({id:i.id,candidate:i.candidate?.name||"Unknown"})));const d=document.getElementById("chat_list_view"),c=document.getElementById("chat_messages_view");return(!u||e)&&(d&&(d.style.setProperty("display","flex","important"),d.style.setProperty("visibility","visible","important"),d.style.setProperty("opacity","1","important"),console.log("üìã Chat list view shown via loadActiveChats.")),c&&(c.style.setProperty("display","none","important"),c.style.setProperty("visibility","hidden","important"),c.style.setProperty("opacity","0","important"),console.log("üìã Chat messages view hidden via loadActiveChats.")),e&&(u=null,b=null,console.log("üìã Switched to chat list view, currentChatId cleared."))),z(f),B=!1,f}).catch(t=>(console.error("‚ùå Error loading chats:",t),B=!1,f)))};function se(e){const s=document.getElementById("chat_list");if(!s)return;const t=s.querySelector(`.chat-item[data-chat-id="${e}"]`);if(!t)return;t.classList.remove("chat-ended");const n=t.querySelector(".ki-cross-circle");n&&n.remove(),console.log("‚úÖ Removed ended styling from chat",e)}function Z(e){const s=document.getElementById("chat_list");s&&e.forEach(t=>{const n=s.querySelector(`.chat-item[data-chat-id="${t.id}"]`);if(!n)return;const o=t.unread_count||0,r=n.querySelector(".bg-accent\\/60.size-11, .bg-accent\\/60");if(!r)return;const a=r.querySelector(".absolute.top-0.end-0");if(a&&a.remove(),o>0){const d=document.createElement("span");d.className="absolute top-0 end-0 flex items-center justify-center w-[18px] h-[18px] rounded-full bg-red-500 text-white text-[10px] font-semibold leading-none z-10",d.style.boxSizing="border-box",d.style.backgroundColor="rgb(239, 68, 68)",d.style.color="white",d.style.display="flex",d.style.visibility="visible",d.style.opacity="1",d.style.position="absolute",d.style.top="-2px",d.style.right="-2px",d.style.zIndex="10",d.style.width="18px",d.style.height="18px",d.style.borderRadius="50%",d.style.transform="none",d.textContent=o>9?"9+":o.toString(),r.appendChild(d),console.log("‚úÖ Added badge to chat",t.id,"with unread count:",o)}})}function z(e){console.log("üìã renderChatList called with chats:",e);const s=document.getElementById("chat_list"),t=document.getElementById("chat_list_empty"),n=document.getElementById("chat_list_view");if(!s){console.error("‚ùå chat_list element not found!");return}n&&!u?(n.style.setProperty("display","flex","important"),n.style.setProperty("visibility","visible","important"),n.style.setProperty("opacity","1","important"),console.log("‚úÖ chat_list_view is now visible")):n&&u?(n.style.setProperty("display","none","important"),n.style.setProperty("visibility","hidden","important"),n.style.setProperty("opacity","0","important")):console.error("‚ùå chat_list_view element not found!"),ie(),t&&(t.style.display=e.length===0?"flex":"none");const o=s.querySelectorAll(".chat-item"),r=o.length,a=Array.from(o).map(l=>parseInt(l.getAttribute("data-chat-id"))),d=e.map(l=>l.id).sort((l,p)=>l-p),c=a.sort((l,p)=>l-p);if(r>0&&r===e.length&&JSON.stringify(c)===JSON.stringify(d)){console.log("üìã Updating unread counts for existing chat items (no re-render needed)"),Z(e),e.forEach(l=>{const p=s.querySelector(`.chat-item[data-chat-id="${l.id}"]`);if(p&&l.last_message){const v=p.querySelector(".text-xs.text-muted-foreground"),_=p.querySelector(".text-xs.text-gray-500");v&&l.last_message.message&&(v.textContent=l.last_message.message),_&&l.last_message.time&&(_.textContent=l.last_message.time)}}),e.forEach(l=>{const p=s.querySelector(`.chat-item[data-chat-id="${l.id}"]`);if(!p)return;const v=!l.is_active;if(v&&!p.classList.contains("chat-ended"))p.classList.add("chat-ended");else if(!v&&p.classList.contains("chat-ended")){p.classList.remove("chat-ended");const _=p.querySelector(".ki-cross-circle");_&&_.remove()}});return}if(o.forEach(l=>l.remove()),r>0&&console.log(`üóëÔ∏è Removed ${r} existing chat item(s) from DOM`),e.length===0){console.log("üìã No chats to display, showing empty state");return}console.log("üìã Rendering",e.length,"chats");const y=[...e].sort((l,p)=>{const v=l.last_message?new Date(l.last_message.created_at).getTime():l.updated_at?new Date(l.updated_at).getTime():0;return(p.last_message?new Date(p.last_message.created_at).getTime():p.updated_at?new Date(p.updated_at).getTime():0)-v});console.log("üìã Sorted chats:",y.map(l=>({id:l.id,latest:l.last_message?.created_at||l.updated_at||"none"}))),y.forEach((l,p)=>{const v=document.createElement("div");v.className=`chat-item p-3 border-b border-border cursor-pointer hover:bg-muted/50 ${l.id===u?"bg-muted/30":""}`,v.setAttribute("data-chat-id",l.id),v.onclick=()=>selectChat(l.id);const _=l.candidate&&l.candidate.name?l.candidate.name:"Onbekend",m=l.last_message?l.last_message.message:"",w=l.last_message&&l.last_message.time?l.last_message.time:"",h=l.candidate&&l.candidate.avatar?l.candidate.avatar:null,P=l.unread_count!==void 0&&l.unread_count!==null?parseInt(l.unread_count):0;console.log("üî¥ Backend Chat",l.id,"candidate:",_,"unread_count:",P,"chat.unread_count:",l.unread_count,"chat keys:",Object.keys(l)),P>0?console.log("‚úÖ Will add badge for chat",l.id,"with count:",P):console.log("‚ùå No badge for chat",l.id,"unread_count is:",P);const C=l.is_ended_by_other_party===!0;l.is_ended_by_current_user;const I=!l.is_active;I&&v.classList.add("chat-ended"),v.innerHTML=`
            <div class="flex items-center gap-3">
                <div class="bg-accent/60 flex size-11 shrink-0 items-center justify-center rounded-full border border-border relative" style="position: relative; overflow: visible;">
                    ${h?`<img src="${E(h)}" alt="${E(_)}" class="w-full h-full rounded-full object-cover" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; border-radius: 50%;" onerror="this.parentElement.innerHTML='<span class=\\'text-primary font-semibold text-sm\\' style=\\'position: relative; z-index: 1;\\'>${_.charAt(0).toUpperCase()}</span>'">`:`<span class="text-primary font-semibold text-sm" style="position: relative; z-index: 1;">${_.charAt(0).toUpperCase()}</span>`}
                    ${P>0?`
                        <span class="absolute top-0 end-0 flex items-center justify-center w-[18px] h-[18px] rounded-full bg-red-500 text-white text-[10px] font-semibold leading-none z-10" style="box-sizing: border-box; background-color: rgb(239, 68, 68) !important; color: white !important; display: flex !important; visibility: visible !important; opacity: 1 !important; position: absolute !important; top: -2px !important; right: -2px !important; z-index: 10 !important; width: 18px !important; height: 18px !important; border-radius: 50% !important; transform: none !important;">
                            ${P>9?"9+":P}
                        </span>
                    `:""}
                </div>
                <div class="flex-1 min-w-0">
                    <div class="font-semibold text-sm flex items-center gap-2">
                        ${E(_)}
                        ${I?`<i class="ki-filled ki-cross-circle text-base ${C?"text-gray-400":"text-gray-500"}" title="${C?"Chat be√´indigd door kandidaat":"Chat be√´indigd door jou"}" style="font-size: 1rem !important;"></i>`:""}
                    </div>
                    ${m?`<div class="text-xs text-muted-foreground truncate">${E(m)}</div>`:'<div class="text-xs text-muted-foreground">Geen berichten</div>'}
                </div>
                <div class="flex flex-col items-end gap-1 shrink-0">
                    ${w?`<div class="text-xs text-muted-foreground">${w}</div>`:""}
                </div>
            </div>
        `,s.appendChild(v),console.log(`‚úÖ Added chat item ${p+1} for chat ${l.id} (${_})`)});const g=s.querySelectorAll(".chat-item");console.log("‚úÖ Chat list rendered with",e.length,"items. DOM contains",g.length,"items"),console.log("üìã Chat list container after render:",{children:s.children.length,innerHTML:s.innerHTML.substring(0,200)+"..."})}function ie(){fetch("/admin/chat/candidates",{headers:{"X-CSRF-TOKEN":L()}}).then(e=>e.json()).then(e=>{const s=document.getElementById("chat_candidate_select");s&&e.length>0&&(s.innerHTML='<option value="">Selecteer een kandidaat...</option>'+e.map(t=>`<option value="${t.id}" data-match-id="${t.match_id||""}">${t.name}${t.vacancy_title?" - "+t.vacancy_title:""}</option>`).join(""))}).catch(e=>{console.error("Error loading candidates:",e)})}window.handleCandidateSelect=function(){const e=document.getElementById("chat_candidate_select");if(!e||!e.value)return;const s=e.options[e.selectedIndex],t=e.value,n=s.getAttribute("data-match-id");t&&(openChatWithCandidate(t,n||null,n?"match":"application"),e.value="")};window.selectChat=function(e){if(!e){console.error("‚ùå selectChat called without chatId");return}console.log("üîµ selectChat called with chatId:",e);let s=f.find(r=>r.id===e);console.log("üîµ Found chat in activeChats:",s?"Yes":"No");const t=document.getElementById("chat_drawer"),n=document.getElementById("chat_drawer_backdrop");if(t){console.log("üîµ Setting drawer attributes..."),A=!1,t.removeAttribute("data-drawer-closed"),t.classList.remove("hidden"),x=!0;try{t.style.setProperty("display","flex","important"),t.style.setProperty("visibility","visible","important"),t.style.setProperty("opacity","1","important"),t.style.setProperty("z-index","99999","important"),t.style.setProperty("transform","translateX(0)","important"),t.style.setProperty("right","1.25rem","important"),t.style.setProperty("left","unset","important"),t.setAttribute("data-chat-active","true"),t.setAttribute("data-ignore-observer","true"),window.chatDrawerObserver&&window.chatDrawerObserver.disconnect();const r=()=>{x=!0;try{t.style.setProperty("transform","translateX(0)","important"),t.style.setProperty("translate","0 0","important"),t.style.setProperty("right","1.25rem","important"),t.style.setProperty("left","auto","important"),t.style.setProperty("--tw-translate-x","0","important"),t.style.setProperty("inset-inline-start","auto","important"),t.style.setProperty("display","flex","important"),t.style.setProperty("transition","none","important"),t.style.setProperty("animation","none","important")}finally{setTimeout(()=>{x=!1},10)}};r(),requestAnimationFrame(()=>{r(),requestAnimationFrame(()=>{r()})}),setTimeout(r,10),setTimeout(r,50),setTimeout(r,100)}finally{setTimeout(()=>{x=!1},150)}console.log("üîµ Drawer should be visible now, computed display:",window.getComputedStyle(t).display)}else console.error("‚ùå Drawer element not found in selectChat!");if(n&&(n.classList.remove("hidden"),n.style.setProperty("display","block","important"),n.style.setProperty("visibility","visible","important"),n.style.setProperty("z-index","99998","important")),!s)if(b&&b.id===e)s=b,f.findIndex(a=>a.id===e)===-1&&f.unshift(s);else return loadActiveChats(!1,!1).then(()=>{s=f.find(r=>r.id===e),s?(u=e,b=s,W(s),H(e,!0),Y(e)):console.error("‚ùå Chat not found after reload:",e)});u=e,b=s;const o=document.getElementById("chat_messages");o&&(console.log("üßπ Clearing messages container before switching to chat:",e),o.innerHTML=""),W(s),H(e,!0),Y(e)};function W(e){console.log("üü¢ updateChatViews called with chat:",e);const s=document.getElementById("chat_list_view"),t=document.getElementById("chat_messages_view"),n=document.getElementById("chat_header_name"),o=document.getElementById("chat_header_avatar"),r=document.getElementById("chat_user_avatar"),a=document.getElementById("chat_drawer"),d=document.getElementById("chat_drawer_backdrop");if(a){A=!1,a.removeAttribute("data-drawer-closed"),a.classList.remove("hidden"),x=!0;try{a.style.setProperty("display","flex","important"),a.style.setProperty("visibility","visible","important"),a.style.setProperty("opacity","1","important"),a.style.setProperty("z-index","99999","important"),a.style.setProperty("transform","translateX(0)","important"),a.style.setProperty("right","1.25rem","important"),a.style.setProperty("left","unset","important"),a.style.setProperty("transition","none","important"),a.style.setProperty("animation","none","important"),a.setAttribute("data-chat-active","true")}finally{setTimeout(()=>{x=!1},10)}console.log("üü¢ Drawer made visible in updateChatViews, computed display:",window.getComputedStyle(a).display)}if(d&&(d.classList.remove("hidden"),d.style.setProperty("display","block","important"),d.style.setProperty("visibility","visible","important"),d.style.setProperty("z-index","99998","important")),s?(s.style.setProperty("display","none","important"),s.style.setProperty("visibility","hidden","important"),s.style.setProperty("opacity","0","important"),console.log("üü¢ Chat list view hidden")):console.error("‚ùå chat_list_view element not found!"),t?(t.style.setProperty("display","flex","important"),t.style.setProperty("visibility","visible","important"),t.style.setProperty("opacity","1","important"),t.classList.remove("hidden"),console.log("üü¢ Chat messages view shown")):console.error("‚ùå chat_messages_view element not found!"),e){if(n&&e.candidate&&(n.textContent=e.candidate.name),o&&e.candidate){const c=o.parentElement;if(e.candidate.avatar&&!e.candidate.avatar.includes("/assets/media/avatars/300-5.png"))if(c&&(c.style.overflow="visible"),o.tagName==="SPAN"){const i=document.createElement("img");i.src=e.candidate.avatar,i.alt=e.candidate.name,i.className="w-full h-full rounded-full object-cover",i.style.cssText="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; border-radius: 50%; object-fit: cover;",i.onerror=function(){this.remove(),o.textContent=e.candidate.name.charAt(0).toUpperCase(),o.style.display="block"},o.style.display="none",c.appendChild(i)}else o.tagName==="IMG"&&(o.src=e.candidate.avatar,o.style.cssText="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; border-radius: 50%; object-fit: cover;",o.onerror=function(){const i=this.parentElement;i.innerHTML=`<span class="text-primary font-semibold text-sm" id="chat_header_avatar" style="position: relative; z-index: 1;">${e.candidate.name.charAt(0).toUpperCase()}</span>`});else if(o.tagName==="SPAN")o.textContent=e.candidate.name.charAt(0).toUpperCase(),o.style.display="block";else{const i=o.parentElement;i.innerHTML=`<span class="text-primary font-semibold text-sm" id="chat_header_avatar" style="position: relative; z-index: 1;">${e.candidate.name.charAt(0).toUpperCase()}</span>`}K(e)}r&&e.user&&e.user.avatar&&(r.src=e.user.avatar)}setTimeout(()=>{ee(),re();const c=document.getElementById("chat_message_input");c&&c.focus()},100)}function K(e,s=null){if(!e||!e.id)return;const t=document.getElementById("chat_header_avatar")?.parentElement;if(!t)return;const n=t.querySelector(".kt-avatar-indicator");n&&n.remove();let o=!1;s&&s.is_online!==void 0?o=s.is_online:e.candidate&&e.candidate.is_online!==void 0&&(o=e.candidate.is_online);const r=document.createElement("div");r.className="kt-avatar-indicator -bottom-2 -end-2",r.innerHTML=`<div class="kt-avatar-status ${o?"kt-avatar-status-online":"kt-avatar-status-offline"}"></div>`,t.appendChild(r)}function re(){const e=document.querySelector("#chat_messages_view .kt-scrollable-y-auto");e&&(e.removeEventListener("scroll",G),e.addEventListener("scroll",G),j())}function G(){if(N)return;const e=document.querySelector("#chat_messages_view .kt-scrollable-y-auto");if(!e)return;e.scrollHeight-e.scrollTop<=e.clientHeight+50?O=!1:O=!0,j()}window.showChatList=function(){console.log("üìã showChatList called");const e=document.getElementById("chat_drawer");console.log("üìã showChatList - drawer BEFORE:",{exists:!!e,hidden:e?.classList.contains("hidden"),"data-user-opened":e?.getAttribute("data-user-opened"),"data-drawer-closed":e?.getAttribute("data-drawer-closed"),"data-chat-active":e?.getAttribute("data-chat-active"),display:e?window.getComputedStyle(e).display:"N/A",visibility:e?window.getComputedStyle(e).visibility:"N/A"}),u=null,b=null,e&&e.getAttribute("data-user-opened")==="true"&&(e.setAttribute("data-chat-active","true"),e.removeAttribute("data-drawer-closed"),e.classList.remove("hidden"),e.style.setProperty("display","flex","important"),e.style.setProperty("visibility","visible","important"),e.style.setProperty("opacity","1","important"),e.style.setProperty("z-index","99999","important"),e.style.setProperty("transform","translateX(0)","important"),e.style.setProperty("right","1.25rem","important"),e.style.setProperty("left","unset","important"),e.style.setProperty("top","1.25rem","important"),e.style.setProperty("bottom","1.25rem","important"),e.style.setProperty("width","450px","important"),e.style.setProperty("max-width","90%","important"),e.style.setProperty("position","fixed","important"),e.style.setProperty("margin-left","0","important")),console.log("üìã showChatList - calling loadActiveChats(true)"),loadActiveChats(!0).then(()=>{if(console.log("üìã showChatList - loadActiveChats completed"),e&&e.getAttribute("data-user-opened")==="true"){e.setAttribute("data-chat-active","true"),e.removeAttribute("data-drawer-closed"),e.classList.remove("hidden"),e.style.setProperty("display","flex","important"),e.style.setProperty("visibility","visible","important"),e.style.setProperty("opacity","1","important"),e.style.setProperty("z-index","99999","important"),e.style.setProperty("transform","translateX(0)","important"),e.style.setProperty("right","1.25rem","important"),e.style.setProperty("left","unset","important"),e.style.setProperty("top","1.25rem","important"),e.style.setProperty("bottom","1.25rem","important"),e.style.setProperty("width","450px","important"),e.style.setProperty("max-width","90%","important"),e.style.setProperty("position","fixed","important"),e.style.setProperty("margin-left","0","important");const s=document.getElementById("chat_drawer_backdrop");s&&(s.classList.remove("hidden"),s.style.setProperty("display","block","important"),s.style.setProperty("visibility","visible","important"))}e&&console.log("üìã showChatList - drawer AFTER loadActiveChats:",{hidden:e.classList.contains("hidden"),"data-user-opened":e.getAttribute("data-user-opened"),"data-drawer-closed":e.getAttribute("data-drawer-closed"),"data-chat-active":e.getAttribute("data-chat-active"),display:window.getComputedStyle(e).display,visibility:window.getComputedStyle(e).visibility})})};function ee(){const e=document.getElementById("chat_message_input");if(!e){console.warn("‚ö†Ô∏è Chat input not found, will retry...");return}const s=e.cloneNode(!0);e.parentNode.replaceChild(s,e);const t=function(){s.style.height="auto",s.style.height=Math.min(s.scrollHeight,200)+"px"};s.addEventListener("keypress",function(o){o.key==="Enter"&&!o.shiftKey?(o.preventDefault(),console.log("‚å®Ô∏è Enter key pressed, calling sendMessage"),window.sendMessage?window.sendMessage():console.error("‚ùå sendMessage function not found!")):onChatMessageInput&&onChatMessageInput()}),s.addEventListener("input",function(){t(),onChatMessageInput&&onChatMessageInput()}),t(),setTimeout(()=>{s.focus()},50);const n=document.getElementById("chat_send_button");n&&!n.hasAttribute("data-send-listener-added")?(n.setAttribute("data-send-listener-added","true"),n.addEventListener("click",function(o){o.preventDefault(),o.stopPropagation(),console.log("üîµ Send button clicked via event listener"),window.sendMessage?window.sendMessage():console.error("‚ùå sendMessage function not found!")}),console.log("‚úÖ Send button event listener added")):n||console.warn("‚ö†Ô∏è Send button not found!"),console.log("‚úÖ Chat input event listeners initialized")}function H(e,s=!1){if(console.log("üì• Loading messages for chat:",e,"showLoader:",s),s){const t=document.getElementById("chat_messages_loader");t&&(t.style.display="flex")}if(u!==e){const t=document.getElementById("chat_messages");t&&(console.log("üßπ Clearing messages container for new chat"),t.innerHTML="")}return fetch(`/admin/chat/${e}/messages`,{headers:{"X-CSRF-TOKEN":L()}}).then(t=>{if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return t.json()}).then(t=>{console.log("‚úÖ Messages loaded:",t);let n=null;if(Array.isArray(t)?t=t:t&&t.messages&&(n=t.presence,t=t.messages),Array.isArray(t))if(u===e){ne(t,e);const o=document.getElementById("chat_messages_loader");o&&(o.style.display="none"),setTimeout(()=>{T()},100);const r=f.findIndex(a=>a.id===e);if(r!==-1){f[r].unread_count=0,Z([f[r]]);const a=f[r];n&&(a.candidate=a.candidate||{},a.candidate.is_online=n.is_online||!1),K(a,n)}}else{console.log("‚è≠Ô∏è Skipping render - chat changed from",e,"to",u);const o=document.getElementById("chat_messages_loader");o&&(o.style.display="none")}else{console.error("‚ùå Messages is not an array:",t);const o=document.getElementById("chat_messages_loader");o&&(o.style.display="none")}return t}).catch(t=>{console.error("‚ùå Error loading messages:",t);const n=document.getElementById("chat_messages_loader");throw n&&(n.style.display="none"),t})}function D(){const e=document.getElementById("chat_messages");if(!e)return;const s=Array.from(e.querySelectorAll(".flex.items-end"));if(s.length===0)return;const t=s.map(n=>{const o=n.getAttribute("data-timestamp");let r=null;if(o)r=new Date(o);else{const a=n.querySelector(".text-xs.font-medium");if(a){const d=a.textContent.trim(),c=new Date,[i,y]=d.split(":").map(Number);!isNaN(i)&&!isNaN(y)&&(r=new Date(c.getFullYear(),c.getMonth(),c.getDate(),i,y))}r||(r=new Date)}return{element:n,timestamp:r}});t.sort((n,o)=>n.timestamp.getTime()-o.timestamp.getTime()),t.forEach(({element:n})=>{e.appendChild(n)})}function ne(e,s=null){console.log("üé® Rendering messages:",e,"for chat:",s||u);const t=document.getElementById("chat_messages");if(!t){console.error("‚ùå Messages container not found!");return}if(s!==null&&s!==u){console.log("‚è≠Ô∏è Skipping render - chat mismatch. Expected:",s,"Current:",u);return}t.querySelectorAll(".flex.items-end.justify-end").forEach(m=>{const w=m.querySelector(".kt-avatar-indicator");w&&w.remove()});const o=t.querySelectorAll('[data-optimistic="false"]');console.log("üßπ Removing",o.length,"existing real messages"),o.forEach(m=>m.remove());const r=Array.from(t.querySelectorAll('[data-optimistic="true"]')),a=r.map(m=>{const w=m.getAttribute("data-message-text")||m.querySelector(".kt-card p")?.textContent||"",h=m.getAttribute("data-optimistic-id"),P=m.getAttribute("data-timestamp"),C=m.getAttribute("data-chat-id");return C&&C!==String(u)?(console.log("üóëÔ∏è Removing optimistic message from different chat:",C,"current:",u),m.remove(),null):{element:m,text:w,id:h,timestamp:P?new Date(P):new Date}}).filter(m=>m!==null),d=Array.isArray(e)&&e.length>0,c=r.length>0,i=d||c;let y=t.querySelector(".chat-empty-message");if(i?y&&y.remove():y||(y=document.createElement("div"),y.className="chat-empty-message text-center text-muted-foreground p-4",y.textContent="Geen berichten",t.appendChild(y)),!d)return void 0;const g=new Set,l=new Map;Array.from(t.querySelectorAll(".flex.items-end")).forEach(m=>{if(!(m.getAttribute("data-optimistic")==="true")){const h=m.getAttribute("data-message-id");h&&(g.add(h),l.set(h,m))}}),new Set(a.map(({text:m})=>m));const v=e.filter(m=>!(m.id&&g.has(String(m.id))));if(v.length===0){console.log("‚úÖ No new messages to render, all messages already exist or are optimistic"),a.forEach(({element:P,text:C,timestamp:I})=>{if(!C||!I)return;const M=e.filter(k=>k.message===C);if(M.length===0)return;let S=null,q=1/0;if(M.forEach(k=>{if(k.created_at){const te=new Date(k.created_at),U=Math.abs(te.getTime()-I.getTime());U<q&&(q=U,S=k)}}),S&&q<5e3){const k=t.querySelector(`[data-optimistic="false"][data-message-id="${S.id}"]`);k&&k.offsetParent!==null?(console.log("üîÑ Removing optimistic message, matching real message exists in DOM:",C,"ID:",S.id),P.remove(),D()):console.log("‚è≥ Keeping optimistic message, real message not yet in DOM or visible:",C)}}),D();const w=t.querySelectorAll(".flex.items-end").length>0;let h=t.querySelector(".chat-empty-message");w?h&&h.remove():h||(h=document.createElement("div"),h.className="chat-empty-message text-center text-muted-foreground p-4",h.textContent="Geen berichten",t.appendChild(h)),T();return}const _=v.map(m=>{const w=m.is_own;if(m.sender_name&&m.sender_name.charAt(0).toUpperCase(),w){const h=b&&b.user&&b.user.avatar?b.user.avatar:"/assets/media/avatars/300-2.png",P=m.created_at?new Date(m.created_at).toISOString():new Date().toISOString();return`
                <div class="flex items-end justify-end gap-3.5 px-5" data-optimistic="false" data-message-id="${m.id||""}" data-message-text="${E(m.message)}" data-timestamp="${P}" data-chat-id="${u||""}">
                    <div class="flex flex-col gap-1.5">
                        <div class="kt-card bg-primary rounded-be-none flex flex-col gap-2.5 p-3 shadow-none">
                            <p class="text-2sm text-primary-foreground font-medium">${E(m.message)}</p>
                        </div>
                        <div class="relative flex items-center justify-end gap-2">
                            <span class="text-xs font-medium text-secondary-foreground">${m.time}</span>
                            ${m.is_read!==void 0?`<i class="ki-filled ki-double-check text-lg ${m.is_read?"text-green-500":"text-gray-400"}"></i>`:""}
                        </div>
                    </div>
                    <div class="relative shrink-0">
                        <div class="kt-avatar size-9">
                            <div class="kt-avatar-image">
                                <img alt="${m.sender_name}" class="size-9 rounded-full object-cover" src="${h}" />
                            </div>
                        </div>
                    </div>
                </div>
            `}else{const h=m.sender_avatar||"/assets/media/avatars/300-5.png";m.user&&m.user.is_online!==void 0&&m.user.is_online;const P=m.created_at?new Date(m.created_at).toISOString():new Date().toISOString();return`
                <div class="flex items-end gap-3.5 px-5" data-optimistic="false" data-message-id="${m.id||""}" data-message-text="${E(m.message)}" data-timestamp="${P}" data-chat-id="${u||""}">
                    <div class="relative shrink-0">
                        <div class="kt-avatar size-9">
                            <div class="kt-avatar-image">
                                <img alt="${E(m.sender_name)}" class="size-9 rounded-full object-cover" src="${E(h)}" onerror="this.src='/assets/media/avatars/300-5.png'" />
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col gap-1.5">
                        <div class="kt-card bg-accent/60 rounded-bs-none text-2sm flex flex-col gap-2.5 p-3 shadow-none relative">
                            ${E(m.message)}
                        </div>
                        <div class="relative flex items-center gap-2">
                            <span class="text-xs font-medium text-muted-foreground">${m.time}</span>
                            ${m.is_read!==void 0?`<i class="ki-filled ki-double-check text-lg ${m.is_read?"text-green-500":"text-gray-400"}"></i>`:""}
                        </div>
                    </div>
                </div>
            `}}).join("");_&&t.insertAdjacentHTML("beforeend",_),D(),T(),a.forEach(({element:m,text:w,timestamp:h,id:P})=>{if(!m||!m.parentNode||!w||!h)return;const C=e.filter(S=>S.message===w);if(C.length===0){console.log("‚è≥ Keeping optimistic message, no matching message in response yet:",w);return}let I=null,M=1/0;C.forEach(S=>{if(S.created_at){const q=new Date(S.created_at),k=Math.abs(q.getTime()-h.getTime());k<M&&(M=k,I=S)}}),I&&M<5e3?setTimeout(()=>{if(m&&m.parentNode){const S=t.querySelector(`[data-optimistic="false"][data-message-id="${I.id}"]`);S&&S.offsetParent!==null?(console.log("üîÑ Removing optimistic message, matching real message exists in DOM:",w,"ID:",I.id,"timeDiff:",M),m.remove(),D(),T()):console.log("‚è≥ Keeping optimistic message, real message not yet visible:",w)}},150):console.log("‚è≥ Keeping optimistic message, no close timestamp match found:",w,"closestTimeDiff:",M)}),console.log("‚úÖ Messages rendered, count:",e.length,"new messages:",v.length,"optimistic preserved:",a.length,"container:",t),requestAnimationFrame(()=>{const w=t.querySelectorAll(".flex.items-end").length>0;let h=t.querySelector(".chat-empty-message");w?h&&h.remove():h||(h=document.createElement("div"),h.className="chat-empty-message text-center text-muted-foreground p-4",h.textContent="Geen berichten",t.appendChild(h))})}function oe(e,s=!1){const t=document.getElementById("chat_messages");if(!t)return console.error("‚ùå Messages container not found!"),null;const n=t.querySelector(".chat-empty-message");n&&n.remove();const o=b&&b.user&&b.user.avatar?b.user.avatar:"/assets/media/avatars/300-2.png",r=new Date,a=r.toLocaleTimeString("nl-NL",{hour:"2-digit",minute:"2-digit"}),d=r.toISOString(),c=s?`optimistic-${Date.now()}-${Math.random().toString(36).substr(2,9)}`:null,i=document.createElement("div");return i.className="flex items-end justify-end gap-3.5 px-5",i.setAttribute("data-optimistic",s?"true":"false"),i.setAttribute("data-message-text",E(e)),i.setAttribute("data-timestamp",d),i.setAttribute("data-chat-id",String(u||"")),c&&i.setAttribute("data-optimistic-id",c),i.innerHTML=`
        <div class="flex flex-col gap-1.5">
            <div class="kt-card bg-primary rounded-be-none flex flex-col gap-2.5 p-3 shadow-none">
                <p class="text-2sm text-primary-foreground font-medium">${E(e)}</p>
            </div>
            <div class="relative flex items-center justify-end gap-2">
                <span class="text-xs font-medium text-secondary-foreground">${a}</span>
                ${s?'<i class="ki-filled ki-time text-lg text-gray-400"></i>':""}
            </div>
        </div>
        <div class="relative shrink-0">
            <div class="kt-avatar size-9">
                <div class="kt-avatar-image">
                    <img alt="You" class="size-9 rounded-full object-cover" src="${o}" />
                </div>
            </div>
        </div>
    `,t.appendChild(i),D(),T(),i}window.sendMessage=function(){console.log("üîµ sendMessage called");const e=document.getElementById("chat_message_input");if(!e){console.error("‚ùå Chat input element not found!");return}if(!e.value||!e.value.trim()){console.warn("‚ö†Ô∏è Cannot send message: input is empty");return}if(!u){console.warn("‚ö†Ô∏è Cannot send message: no chat selected, currentChatId:",u);return}const s=e.value.trim();console.log("üì§ Sending message:",s,"to chat:",u);const t=oe(s,!0);e.value="",e.style&&(e.style.height="auto");const n=new FormData;n.append("message",s);const o=L();if(!o){console.error("‚ùå CSRF token not found!"),t&&t.remove(),e.value=s;return}fetch(`/admin/chat/${u}/message`,{method:"POST",headers:{"X-CSRF-TOKEN":o,Accept:"application/json"},body:n}).then(r=>(console.log("üì° Response status:",r.status),r.ok?r.json():r.text().then(a=>{throw console.error("‚ùå Response error:",a),new Error(`HTTP error! status: ${r.status}, body: ${a}`)}))).then(r=>{if(console.log("‚úÖ Message sent successfully:",r),r.success&&r.message){const a=document.getElementById("chat_messages");let d=!1;if(a)if(r.message.id?a.querySelector(`[data-optimistic="false"][data-message-id="${r.message.id}"]`):null)t&&t.remove();else{const i=b&&b.user&&b.user.avatar?b.user.avatar:"/assets/media/avatars/300-2.png",y=r.message.created_at?new Date(r.message.created_at).toISOString():new Date().toISOString(),g=`
                        <div class="flex items-end justify-end gap-3.5 px-5" data-optimistic="false" data-message-id="${r.message.id||""}" data-message-text="${E(r.message.message)}" data-timestamp="${y}" data-chat-id="${u||""}">
                            <div class="flex flex-col gap-1.5">
                                <div class="kt-card bg-primary rounded-be-none flex flex-col gap-2.5 p-3 shadow-none">
                                    <p class="text-2sm text-primary-foreground font-medium">${E(r.message.message)}</p>
                                </div>
                                <div class="relative flex items-center justify-end gap-2">
                                    <span class="text-xs font-medium text-secondary-foreground">${r.message.time}</span>
                                    ${r.message.is_read!==void 0?`<i class="ki-filled ki-double-check text-lg ${r.message.is_read?"text-green-500":"text-gray-400"}"></i>`:""}
                                </div>
                            </div>
                            <div class="relative shrink-0">
                                <div class="kt-avatar size-9">
                                    <div class="kt-avatar-image">
                                        <img alt="${r.message.sender_name}" class="size-9 rounded-full object-cover" src="${i}" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;a.insertAdjacentHTML("beforeend",g),d=!0,b&&K(b),D(),T(),requestAnimationFrame(()=>{const l=a.querySelector(`[data-optimistic="false"][data-message-id="${r.message.id||""}"]`);l&&l.offsetParent!==null?t&&t.parentNode&&(console.log("üîÑ Removing optimistic message, real message confirmed in DOM"),t.remove(),D(),T()):(console.log("‚è≥ Keeping optimistic message, real message not yet visible"),setTimeout(()=>{const p=a.querySelector(`[data-optimistic="false"][data-message-id="${r.message.id||""}"]`);p&&p.offsetParent!==null&&t&&t.parentNode&&(t.remove(),D(),T())},50))}),T()}if(b&&r.message){b.last_message={message:r.message.message,created_at:r.message.created_at,time:r.message.time};const c=f.findIndex(i=>i.id===u);c!==-1&&(f[c].last_message=b.last_message,f[c].updated_at=r.message.created_at||new Date().toISOString(),f[c].is_active=!0,f[c].is_ended_by_other_party=!1,f[c].is_ended_by_current_user=!1,f[c].ended_at=null)}se(u),d&&(setTimeout(()=>{H(u,!1)},500),setTimeout(()=>{const c=document.getElementById("chat_list_view");c&&window.getComputedStyle(c).display!=="none"?(z(f),loadActiveChats(!1).then(()=>{z(f)})):loadActiveChats(!1)},600))}else console.error("‚ùå Message send failed:",r),t&&t.remove(),e.value=s}).catch(r=>{console.error("‚ùå Error sending message:",r),t&&t.remove(),e.value=s})};window.handleDrawerClose=function(){const e=document.getElementById("chat_drawer"),s=document.getElementById("chat_drawer_backdrop");if(!e)return;if(e.getAttribute("data-user-opened")==="true"){console.log("üîí handleDrawerClose called but drawer should stay open (data-user-opened=true)"),e.classList.remove("hidden"),e.removeAttribute("data-drawer-closed"),e.style.setProperty("display","flex","important"),e.style.setProperty("visibility","visible","important"),e.style.setProperty("opacity","1","important");return}console.log("üîí handleDrawerClose called - closing drawer"),A=!0,u=null,b=null;const t=()=>{e&&(e.setAttribute("data-drawer-closed","true"),e.removeAttribute("style"),e.classList.add("hidden"),e.removeAttribute("data-chat-active"),e.style.cssText="display: none !important; visibility: hidden !important; opacity: 0 !important; transform: translateX(100%) !important; right: -100% !important; left: unset !important; z-index: -1 !important;",e.classList.remove("open"))},n=()=>{s&&(s.removeAttribute("style"),s.classList.add("hidden"),s.style.cssText="display: none !important; visibility: hidden !important; opacity: 0 !important; z-index: -1 !important;")};if(window.KTDrawer){const c=window.KTDrawer.getInstance(e);if(c)try{c.hide()}catch(i){console.log("‚ö†Ô∏è Error hiding drawer instance:",i)}}const o=document.querySelector('[data-kt-drawer-toggle="#chat_drawer"]');if(o&&(!e.classList.contains("hidden")||window.getComputedStyle(e).display!=="none"))try{o.click()}catch(i){console.log("‚ö†Ô∏è Error clicking toggle:",i)}t(),n(),[0,10,50,100,200,300,500,1e3].forEach(c=>{setTimeout(()=>{t(),n()},c)});let a=0;const d=setInterval(()=>{e&&A?(t(),n(),a++,a>=30&&clearInterval(d)):clearInterval(d)},100)};window.endChat=function(){if(!u)return;const e=document.documentElement.classList.contains("dark"),s=document.createElement("div");s.style.cssText=`
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: ${e?"rgba(0, 0, 0, 0.7)":"rgba(0, 0, 0, 0.5)"};
        z-index: 999999;
        display: flex;
        align-items: center;
        justify-content: center;
    `;const t=document.createElement("div");t.style.cssText=`
        background-color: ${e?"#1e293b":"#ffffff"};
        color: ${e?"#f1f5f9":"#1e293b"};
        border: 1px solid ${e?"#334155":"#e2e8f0"};
        border-radius: 0.5rem;
        padding: 1.5rem;
        max-width: 400px;
        width: 90%;
        box-shadow: ${e?"0 20px 25px -5px rgba(0, 0, 0, 0.5)":"0 20px 25px -5px rgba(0, 0, 0, 0.1)"};
    `,t.innerHTML=`
        <div style="margin-bottom: 1rem;">
            <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem; color: ${e?"#f1f5f9":"#1e293b"};">
                Chat be√´indigen
            </h3>
            <p style="color: ${e?"#cbd5e1":"#64748b"};">
                Weet je zeker dat je deze chat wilt be√´indigen?
            </p>
        </div>
        <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
            <button id="end-cancel-btn" style="
                padding: 0.5rem 1rem;
                border-radius: 0.375rem;
                border: 1px solid ${e?"#475569":"#cbd5e1"};
                background-color: ${e?"#334155":"#f1f5f9"};
                color: ${e?"#f1f5f9":"#1e293b"};
                cursor: pointer;
                font-weight: 500;
                transition: all 0.2s;
            ">
                Annuleren
            </button>
            <button id="end-confirm-btn" style="
                padding: 0.5rem 1rem;
                border-radius: 0.375rem;
                border: none;
                background-color: #dc2626;
                color: white;
                cursor: pointer;
                font-weight: 500;
                transition: all 0.2s;
            ">
                Be√´indigen
            </button>
        </div>
    `,s.appendChild(t),document.body.appendChild(s);const n=t.querySelector("#end-cancel-btn"),o=t.querySelector("#end-confirm-btn");return n.addEventListener("mouseenter",()=>{n.style.backgroundColor=e?"#475569":"#e2e8f0"}),n.addEventListener("mouseleave",()=>{n.style.backgroundColor=e?"#334155":"#f1f5f9"}),o.addEventListener("mouseenter",()=>{o.style.backgroundColor="#b91c1c"}),o.addEventListener("mouseleave",()=>{o.style.backgroundColor="#dc2626"}),new Promise(r=>{n.addEventListener("click",()=>{document.body.removeChild(s),r(!1)}),o.addEventListener("click",()=>{document.body.removeChild(s),r(!0)}),s.addEventListener("click",a=>{a.target===s&&(document.body.removeChild(s),r(!1))})}).then(r=>{r&&fetch(`/admin/chat/${u}/end`,{method:"POST",headers:{"X-CSRF-TOKEN":L()}}).then(a=>a.json()).then(a=>{if(a.success){u=null,b=null;const d=document.getElementById("chat_drawer");d&&d.removeAttribute("data-chat-active"),loadActiveChats()}}).catch(a=>{console.error("Error ending chat:",a)})})};window.deleteChat=function(){if(!u)return;const e=document.documentElement.classList.contains("dark"),s=document.createElement("div");s.style.cssText=`
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: ${e?"rgba(0, 0, 0, 0.7)":"rgba(0, 0, 0, 0.5)"};
        z-index: 999999;
        display: flex;
        align-items: center;
        justify-content: center;
    `;const t=document.createElement("div");t.style.cssText=`
        background-color: ${e?"#1e293b":"#ffffff"};
        color: ${e?"#f1f5f9":"#1e293b"};
        border: 1px solid ${e?"#334155":"#e2e8f0"};
        border-radius: 0.5rem;
        padding: 1.5rem;
        max-width: 400px;
        width: 90%;
        box-shadow: ${e?"0 20px 25px -5px rgba(0, 0, 0, 0.5)":"0 20px 25px -5px rgba(0, 0, 0, 0.1)"};
    `,t.innerHTML=`
        <div style="margin-bottom: 1rem;">
            <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem; color: ${e?"#f1f5f9":"#1e293b"};">
                Chat verwijderen
            </h3>
            <p style="color: ${e?"#cbd5e1":"#64748b"};">
                Weet je zeker dat je deze chat wilt verwijderen? Deze actie kan niet ongedaan worden gemaakt.
            </p>
        </div>
        <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
            <button id="delete-cancel-btn" style="
                padding: 0.5rem 1rem;
                border-radius: 0.375rem;
                border: 1px solid ${e?"#475569":"#cbd5e1"};
                background-color: ${e?"#334155":"#f1f5f9"};
                color: ${e?"#f1f5f9":"#1e293b"};
                cursor: pointer;
                font-weight: 500;
                transition: all 0.2s;
            ">
                Annuleren
            </button>
            <button id="delete-confirm-btn" style="
                padding: 0.5rem 1rem;
                border-radius: 0.375rem;
                border: none;
                background-color: #dc2626;
                color: white;
                cursor: pointer;
                font-weight: 500;
                transition: all 0.2s;
            ">
                Verwijderen
            </button>
        </div>
    `,s.appendChild(t),document.body.appendChild(s);const n=t.querySelector("#delete-cancel-btn"),o=t.querySelector("#delete-confirm-btn");return n.addEventListener("mouseenter",()=>{n.style.backgroundColor=e?"#475569":"#e2e8f0"}),n.addEventListener("mouseleave",()=>{n.style.backgroundColor=e?"#334155":"#f1f5f9"}),o.addEventListener("mouseenter",()=>{o.style.backgroundColor="#b91c1c"}),o.addEventListener("mouseleave",()=>{o.style.backgroundColor="#dc2626"}),new Promise(r=>{n.addEventListener("click",()=>{document.body.removeChild(s),r(!1)}),o.addEventListener("click",()=>{document.body.removeChild(s),r(!0)}),s.addEventListener("click",a=>{a.target===s&&(document.body.removeChild(s),r(!1))})}).then(r=>{if(!r)return;const a=u;if(!a){console.error("‚ùå Cannot delete chat: currentChatId is null");return}fetch(`/admin/chat/${a}`,{method:"DELETE",headers:{"X-CSRF-TOKEN":L()}}).then(d=>d.json()).then(d=>{if(console.log("üóëÔ∏è Delete chat response:",d),d.success){console.log("‚úÖ Chat deleted successfully, deletedChatId:",a),f=f.filter(p=>p.id!==a),console.log("üìã Active chats after filter:",f.length),u===a&&(u=null,b=null,console.log("üßπ Cleared currentChatId (was:",a,")"));const c=document.getElementById("chat_messages");c&&(c.innerHTML=""),console.log("üßπ Cleared messages container");const i=document.getElementById("chat_drawer");if(console.log("üìÇ Drawer element found:",!!i),i){console.log("üìÇ Drawer BEFORE update:",{hidden:i.classList.contains("hidden"),"data-user-opened":i.getAttribute("data-user-opened"),"data-drawer-closed":i.getAttribute("data-drawer-closed"),"data-chat-active":i.getAttribute("data-chat-active"),display:window.getComputedStyle(i).display,visibility:window.getComputedStyle(i).visibility}),window.chatDrawerObserver&&window.chatDrawerObserver.disconnect(),i.setAttribute("data-user-opened","true"),i.setAttribute("data-chat-active","true"),i.removeAttribute("data-drawer-closed"),i.classList.remove("hidden"),i.style.setProperty("display","flex","important"),i.style.setProperty("visibility","visible","important"),i.style.setProperty("opacity","1","important"),i.style.setProperty("z-index","99999","important"),i.style.setProperty("transform","translateX(0)","important"),i.style.setProperty("translate","0 0","important"),i.style.setProperty("right","1.25rem","important"),i.style.setProperty("left","auto","important"),i.style.setProperty("--tw-translate-x","0","important"),i.style.setProperty("inset-inline-start","auto","important"),i.style.setProperty("top","1.25rem","important"),i.style.setProperty("bottom","1.25rem","important"),i.style.setProperty("width","450px","important"),i.style.setProperty("max-width","90%","important"),i.style.setProperty("position","fixed","important"),i.style.setProperty("margin-left","0","important");const p=document.getElementById("chat_drawer_backdrop");p&&(p.classList.remove("hidden"),p.style.setProperty("display","block","important"),p.style.setProperty("visibility","visible","important"),p.style.setProperty("z-index","99998","important")),console.log("üìÇ Drawer AFTER update:",{hidden:i.classList.contains("hidden"),"data-user-opened":i.getAttribute("data-user-opened"),"data-drawer-closed":i.getAttribute("data-drawer-closed"),"data-chat-active":i.getAttribute("data-chat-active"),display:window.getComputedStyle(i).display,visibility:window.getComputedStyle(i).visibility}),setTimeout(()=>{window.chatDrawerObserver&&i&&i.getAttribute("data-user-opened")==="true"&&window.chatDrawerObserver.observe(i,{attributes:!0,attributeFilter:["class"]})},500)}const y=document.getElementById("chat_list");if(y){const p=y.querySelector(`.chat-item[data-chat-id="${a}"]`);p?(p.remove(),console.log("üóëÔ∏è Removed deleted chat item from DOM, chatId:",a)):(console.log("‚ö†Ô∏è Chat item not found in DOM for chatId:",a,"- will be removed on next render"),z(f))}const g=document.getElementById("chat_list_view"),l=document.getElementById("chat_messages_view");g&&(g.style.setProperty("display","flex","important"),g.style.setProperty("visibility","visible","important"),g.style.setProperty("opacity","1","important")),l&&(l.style.setProperty("display","none","important"),l.style.setProperty("visibility","hidden","important"),l.style.setProperty("opacity","0","important"))}else console.error("‚ùå Delete chat failed:",d)}).catch(d=>{console.error("Error deleting chat:",d)})})};function Y(e){V&&clearInterval(V),F&&clearInterval(F),X&&clearInterval(X),R()&&J(e),V=setInterval(()=>{u&&R()&&H(u)},500),F=setInterval(()=>{u&&R()&&ae(u)},1e3),X=setInterval(()=>{u&&R()&&J(u)},8e3)}function R(){return typeof document.hidden<"u"?!document.hidden:!0}function J(e){fetch(`/admin/chat/${e}/presence`,{method:"POST",headers:{"X-CSRF-TOKEN":L()},keepalive:!0}).catch(s=>{console&&console.error&&console.error("Error sending presence:",s)})}function ae(e){fetch(`/admin/chat/${e}/typing`,{headers:{"X-CSRF-TOKEN":L()}}).then(s=>s.json()).then(s=>{const t=document.getElementById("chat_typing_indicator_header");if(t)if(s.length>0){const n=s.map(o=>o.name).join(", ");t.textContent=`${n} ${s.length===1?"is":"zijn"} aan het typen...`,t.style.display="block"}else t.style.display="none"}).catch(s=>{console.error("Error checking typing:",s)})}window.onChatMessageInput=function(){!document.getElementById("chat_message_input")||!u||fetch(`/admin/chat/${u}/typing`,{method:"POST",headers:{"X-CSRF-TOKEN":L()}})};function T(e=!1){if(!e&&O){j();return}requestAnimationFrame(()=>{const s=document.getElementById("chat_messages");if(s){const t=s.closest(".kt-scrollable-y-auto");t?(N=!0,t.scrollTop=t.scrollHeight,setTimeout(()=>{N=!1,O=!1,j()},100)):(N=!0,s.scrollTop=s.scrollHeight,setTimeout(()=>{N=!1,O=!1,j()},100))}})}function j(){const e=document.querySelector("#chat_messages_view .kt-scrollable-y-auto"),s=document.getElementById("scroll_to_bottom_btn");if(!e||!s)return;e.scrollHeight-e.scrollTop<=e.clientHeight+50?s.style.display="none":s.style.display="flex"}window.scrollToBottomManually=function(){O=!1,T(!0)};function E(e){const s=document.createElement("div");return s.textContent=e,s.innerHTML}document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("chat_drawer"),s=document.getElementById("chat_drawer_backdrop");if(e&&(e.classList.add("hidden"),e.style.display="none",e.style.visibility="hidden",e.style.opacity="0"),s&&(s.classList.add("hidden"),s.style.display="none",s.style.visibility="hidden"),e){let o=new MutationObserver(function(a){a.forEach(function(d){if(d.type==="attributes"&&d.attributeName==="class"){if(e&&e.getAttribute("data-ignore-observer")==="true"||A||e&&e.getAttribute("data-drawer-closed")==="true")return;if(!e.classList.contains("hidden")){if($||x)return;x=!0;try{e.style.setProperty("display","flex","important"),e.style.setProperty("visibility","visible","important"),e.style.setProperty("opacity","1","important"),e.style.setProperty("z-index","99999","important"),e.style.setProperty("transform","translateX(0)","important"),e.style.setProperty("right","1.25rem","important"),e.style.setProperty("left","auto","important"),s.style.setProperty("display","block","important"),s.style.setProperty("visibility","visible","important"),s.style.setProperty("z-index","99998","important")}finally{setTimeout(()=>{x=!1},10)}s&&s.classList.remove("hidden");const i=document.getElementById("chat_list_view"),y=document.getElementById("chat_messages_view");u?(i&&(i.style.setProperty("display","none","important"),i.style.setProperty("visibility","hidden","important"),i.style.setProperty("opacity","0","important")),y&&(y.style.setProperty("display","flex","important"),y.style.setProperty("visibility","visible","important"),y.style.setProperty("opacity","1","important"),y.classList.remove("hidden"))):(i&&(i.style.setProperty("display","flex","important"),i.style.setProperty("visibility","visible","important"),i.style.setProperty("opacity","1","important")),y&&(y.style.setProperty("display","none","important"),y.style.setProperty("visibility","hidden","important"),y.style.setProperty("opacity","0","important"))),loadActiveChats(!1,!1).then(()=>{u||z(f)}),setTimeout(()=>{const g=document.getElementById("chat_candidate_select");g&&!g.hasAttribute("data-listener-attached")&&(g.addEventListener("change",handleCandidateSelect),g.setAttribute("data-listener-attached","true"))},100)}else{const i=u||$||e?.getAttribute("data-chat-active")==="true",y=e?.getAttribute("data-user-opened")==="true",g=i||y;if(console.log("üëÅÔ∏è Observer: Drawer closing detected:",{hasActiveChat:i,hasUserOpened:y,shouldKeepOpen:g,currentChatId:u,isOpeningChat:$,"data-chat-active":e?.getAttribute("data-chat-active"),"data-user-opened":e?.getAttribute("data-user-opened"),"data-drawer-closed":e?.getAttribute("data-drawer-closed"),isDrawerExplicitlyClosed:A}),g){if(console.log("üëÅÔ∏è Observer: Keeping drawer open because shouldKeepOpen is true"),e&&(e.classList.remove("hidden"),e.removeAttribute("data-drawer-closed"),!x)){x=!0;try{e.style.setProperty("display","flex","important"),e.style.setProperty("visibility","visible","important"),e.style.setProperty("opacity","1","important"),e.style.setProperty("z-index","99999","important"),e.style.setProperty("transform","translateX(0)","important"),e.style.setProperty("right","1.25rem","important"),e.style.setProperty("left","auto","important"),y&&e.setAttribute("data-chat-active","true")}finally{setTimeout(()=>{x=!1},10)}}s&&(s.classList.remove("hidden"),s.style.display="block",s.style.visibility="visible")}else{if(e&&e.getAttribute("data-user-opened")==="true"){console.log("üëÅÔ∏è Observer: Keeping drawer open because data-user-opened is true");return}console.log("üëÅÔ∏è Observer: Hiding drawer because shouldKeepOpen is false"),e&&(e.removeAttribute("data-chat-active"),e.removeAttribute("data-user-opened"),e.setAttribute("data-drawer-closed","true"),e.style.display="none",e.style.visibility="hidden",e.style.opacity="0"),s&&(s.classList.add("hidden"),s.style.display="none",s.style.visibility="hidden")}}}})});window.chatDrawerObserver=o,o.observe(e,{attributes:!0,attributeFilter:["class"]}),new MutationObserver(function(a){x||A||e&&e.getAttribute("data-drawer-closed")==="true"||e&&e.getAttribute("data-chat-active")==="true"&&requestAnimationFrame(()=>{if(x)return;const d=window.getComputedStyle(e).transform,c=window.getComputedStyle(e).right,i=window.getComputedStyle(e).left,y=d!=="none"&&d!=="matrix(1, 0, 0, 1, 0, 0)",g=c!=="1.25rem"&&c!=="20px",l=i!=="auto"&&i!=="unset";if(y||g||l){x=!0;try{if(y&&(console.log("üîÑ Style observer: Resetting transform from",d),e.style.setProperty("transform","translateX(0)","important")),g&&(console.log("üîÑ Style observer: Resetting right from",c),e.style.setProperty("right","1.25rem","important")),l){console.log("üîÑ Style observer: Resetting left from",i),e.style.left&&e.style.removeProperty("left");const p=e.getAttribute("style");if(p){const v=p.replace(/left\s*:\s*[^;!]+(!important)?;?/gi,"").trim();v!==p&&e.setAttribute("style",v)}e.style.setProperty("left","auto","important")}}finally{setTimeout(()=>{x=!1},50)}}})}).observe(e,{attributes:!0,attributeFilter:["style","class"],attributeOldValue:!1,childList:!1,subtree:!1}),setInterval(function(){if(x)return;const a=e&&e.getAttribute("data-user-opened")==="true";if((A||e&&e.getAttribute("data-drawer-closed")==="true")&&!a){e&&(e.setAttribute("data-drawer-closed","true"),e.classList.add("hidden"),e.removeAttribute("data-chat-active"),e.style.setProperty("display","none","important"),e.style.setProperty("visibility","hidden","important"),e.style.setProperty("opacity","0","important"),e.style.setProperty("transform","translateX(100%)","important"),e.style.setProperty("right","-100%","important"),e.style.setProperty("z-index","-1","important"),e.classList.remove("open")),s&&(s.classList.add("hidden"),s.style.setProperty("display","none","important"),s.style.setProperty("visibility","hidden","important"),s.style.setProperty("opacity","0","important"),s.style.setProperty("z-index","-1","important"));return}a&&e&&(e.setAttribute("data-chat-active","true"),e.removeAttribute("data-drawer-closed"),e.classList.remove("hidden"),e.style.setProperty("display","flex","important"),e.style.setProperty("visibility","visible","important"),e.style.setProperty("opacity","1","important"),e.style.setProperty("z-index","99999","important"),e.style.setProperty("transform","translateX(0)","important"),e.style.setProperty("right","1.25rem","important"),e.style.setProperty("left","unset","important"),e.style.setProperty("top","1.25rem","important"),e.style.setProperty("bottom","1.25rem","important"),e.style.setProperty("width","450px","important"),e.style.setProperty("max-width","90%","important"),e.style.setProperty("position","fixed","important"),e.style.setProperty("margin-left","0","important"),s&&(s.classList.remove("hidden"),s.style.setProperty("display","block","important"),s.style.setProperty("visibility","visible","important"),s.style.setProperty("z-index","99998","important")));const d=u||$||e&&e.getAttribute("data-chat-active")==="true";if(d&&e){const c=e.classList.contains("hidden"),i=window.getComputedStyle(e).display;(c||i==="none")&&(Q&&console.log("üîÑ Interval: Drawer was hidden, reopening...",{isMarkedHidden:c,computedDisplay:i}),e.classList.remove("hidden")),x=!0;try{e.style.setProperty("display","flex","important"),e.style.setProperty("visibility","visible","important"),e.style.setProperty("opacity","1","important"),e.style.setProperty("z-index","99999","important"),e.style.setProperty("transform","translateX(0)","important"),e.style.setProperty("translate","0 0","important"),e.style.setProperty("right","1.25rem","important"),e.style.setProperty("left","auto","important"),e.style.setProperty("top","1.25rem","important"),e.style.setProperty("bottom","1.25rem","important"),e.style.setProperty("width","450px","important"),e.style.setProperty("max-width","90%","important"),e.style.setProperty("position","fixed","important"),e.style.setProperty("margin-left","0","important"),e.style.setProperty("inset-inline-start","auto","important"),e.style.setProperty("--tw-translate-x","0","important"),e.setAttribute("data-chat-active","true"),e.style.left&&e.style.removeProperty("left"),e.style.setProperty("left","auto","important");const p=e.getAttribute("style");if(p){const v=p.replace(/left\s*:\s*[^;!]+(!important)?;?/gi,"").trim();v!==p&&e.setAttribute("style",v)}e.style.setProperty("left","auto","important"),e.style.setProperty("transition","none","important"),e.style.setProperty("animation","none","important")}finally{setTimeout(()=>{x=!1},10)}const y=window.getComputedStyle(e).transform,g=window.getComputedStyle(e).right,l=window.getComputedStyle(e).left;if(y!=="none"&&y!=="matrix(1, 0, 0, 1, 0, 0)"&&e.style.setProperty("transform","translateX(0)","important"),g!=="1.25rem"&&g!=="20px"&&e.style.setProperty("right","1.25rem","important"),l!=="unset"&&l!=="auto"){e.style.left&&e.style.removeProperty("left");const p=e.getAttribute("style");if(p){const v=p.replace(/left\s*:\s*[^;!]+(!important)?;?/gi,"").trim();v!==p&&e.setAttribute("style",v)}e.style.setProperty("left","auto","important")}s&&(s.classList.remove("hidden"),s.style.setProperty("display","block","important"),s.style.setProperty("visibility","visible","important"),s.style.setProperty("z-index","99998","important"))}else!d&&e&&e.getAttribute("data-chat-active")==="true"&&(console.log("üîÑ Interval: No active chat, removing active flag"),e.removeAttribute("data-chat-active"))},200)}s&&s.addEventListener("click",function(){const o=document.getElementById("chat_drawer");if(o&&o.getAttribute("data-user-opened")==="true"){console.log("üñ±Ô∏è Backdrop clicked but drawer should stay open (data-user-opened=true)");return}window.handleDrawerClose&&window.handleDrawerClose()});const t=document.querySelector('[data-kt-drawer-toggle="#chat_drawer"]');t&&t.addEventListener("click",function(o){e&&(e.classList.contains("hidden")||window.getComputedStyle(e).display==="none")?(A=!1,e&&e.removeAttribute("data-drawer-closed"),console.log("üîì Toggle button clicked - resetting close flag to allow drawer to open")):(A=!0,e&&e.setAttribute("data-drawer-closed","true"),console.log("üîí Toggle button clicked - setting close flag")),setTimeout(()=>{e&&(e.classList.contains("hidden")||window.getComputedStyle(e).display==="none")?(A=!0,e&&e.setAttribute("data-drawer-closed","true")):(A=!1,e&&e.removeAttribute("data-drawer-closed"))},50);const a=()=>{e&&(e.classList.remove("hidden"),e.style.setProperty("display","flex","important"),e.style.setProperty("visibility","visible","important"),e.style.setProperty("opacity","1","important"),e.style.setProperty("z-index","99999","important"),e.style.setProperty("transform","translateX(0)","important"),e.style.setProperty("right","1.25rem","important"),e.style.setProperty("left","auto","important"),e.style.setProperty("transition","none","important"),e.style.setProperty("animation","none","important")),s&&(s.classList.remove("hidden"),s.style.setProperty("display","block","important"),s.style.setProperty("visibility","visible","important"),s.style.setProperty("z-index","99998","important"))};a(),requestAnimationFrame(()=>{a(),requestAnimationFrame(()=>{a()})}),setTimeout(a,10),setTimeout(a,50),setTimeout(a,100),setTimeout(a,200)}),e&&e.querySelectorAll('[data-kt-drawer-dismiss="true"]').forEach(r=>{r.addEventListener("click",function(a){a.preventDefault(),a.stopPropagation(),window.handleDrawerClose&&window.handleDrawerClose()})});const n=document.getElementById("chat_candidate_select");n&&n.addEventListener("change",handleCandidateSelect),setTimeout(()=>{ee()},500),setInterval(()=>{if(!u&&!B){const o=document.getElementById("chat_list_view");o&&window.getComputedStyle(o).display!=="none"&&window.getComputedStyle(o).visibility!=="hidden"&&loadActiveChats(!0,!1)}},3e4),document.addEventListener("keydown",function(o){if(o.key==="Escape"||o.keyCode===27){const r=document.getElementById("chat_drawer");if(r&&window.getComputedStyle(r).display!=="none"&&!r.classList.contains("hidden"))if(o.preventDefault(),o.stopPropagation(),o.stopImmediatePropagation(),console.log("‚å®Ô∏è ESC key pressed - closing drawer"),window.handleDrawerClose)window.handleDrawerClose();else{r.classList.add("hidden"),r.style.cssText="display: none !important; visibility: hidden !important; opacity: 0 !important;";const c=document.getElementById("chat_drawer_backdrop");c&&(c.classList.add("hidden"),c.style.cssText="display: none !important; visibility: hidden !important; opacity: 0 !important;")}}},!0),document.addEventListener("click",function(o){const r=document.getElementById("chat_drawer"),a=document.getElementById("chat_drawer_backdrop");if(!r||A||r.getAttribute("data-drawer-closed")==="true"||!(window.getComputedStyle(r).display!=="none"&&!r.classList.contains("hidden")))return;const i=o.target,y=r.contains(i);a&&(a===i||a.contains(i));const g=i.closest('[data-kt-drawer-toggle="#chat_drawer"]');if(!y&&!g){if(r.getAttribute("data-user-opened")==="true"){console.log("üñ±Ô∏è Click outside drawer but drawer should stay open (data-user-opened=true)");return}console.log("üñ±Ô∏è Click outside drawer - closing drawer"),window.handleDrawerClose&&window.handleDrawerClose()}})});
